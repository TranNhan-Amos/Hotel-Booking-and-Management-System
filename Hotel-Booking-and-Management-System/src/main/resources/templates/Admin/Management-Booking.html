<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Đặt Phòng - Admin</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/Css/Admin/Management-Booking.css}">
    <style>
        /* Toast Notification System */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background: white;
            border-radius: 8px;
            padding: 16px 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-left: 4px solid #4CAF50;
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 300px;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            animation: slideIn 0.3s ease forwards;
        }

        .toast.success {
            border-left-color: #4CAF50;
        }

        .toast.error {
            border-left-color: #f44336;
        }

        .toast.warning {
            border-left-color: #ff9800;
        }

        .toast.info {
            border-left-color: #2196F3;
        }

        .toast-icon {
            font-size: 20px;
            color: #4CAF50;
        }

        .toast.success .toast-icon {
            color: #4CAF50;
        }

        .toast.error .toast-icon {
            color: #f44336;
        }

        .toast.warning .toast-icon {
            color: #ff9800;
        }

        .toast.info .toast-icon {
            color: #2196F3;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            margin-bottom: 4px;
            color: #333;
        }

        .toast-message {
            color: #666;
            font-size: 14px;
        }

        .toast-close {
            background: none;
            border: none;
            font-size: 18px;
            color: #999;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s;
        }

        .toast-close:hover {
            background-color: #f5f5f5;
            color: #666;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* Modal System */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            backdrop-filter: blur(4px);
        }

        .modal {
            background: white;
            border-radius: 12px;
            padding: 0;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .modal.show {
            transform: scale(1);
        }

        .modal-header {
            padding: 20px 24px 0;
            border-bottom: 1px solid #eee;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .modal-body {
            padding: 0 24px 20px;
        }

        .modal-message {
            color: #666;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }

        .btn-primary {
            background: #4CAF50;
            color: white;
        }

        .btn-primary:hover {
            background: #45a049;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #666;
        }

        .btn-secondary:hover {
            background: #e8e8e8;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-danger:hover {
            background: #d32f2f;
            transform: translateY(-1px);
        }

        /* Action Button Styles */
        .actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .view-btn, .cancel-btn, .confirm-payment-btn, .confirm-payment-hotel-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .view-btn {
            background: #2196F3;
            color: white;
        }

        .view-btn:hover {
            background: #1976D2;
            transform: translateY(-1px);
        }

        .cancel-btn {
            background: #f44336;
            color: white;
        }

        .cancel-btn:hover {
            background: #d32f2f;
            transform: translateY(-1px);
        }

        .confirm-payment-btn {
            background: #4CAF50;
            color: white;
        }

        .confirm-payment-btn:hover {
            background: #45a049;
            transform: translateY(-1px);
        }

        .confirm-payment-hotel-btn {
            background: #FF9800;
            color: white;
        }

        .confirm-payment-hotel-btn:hover {
            background: #F57C00;
            transform: translateY(-1px);
        }

        .detail-btn {
            background: #6c757d;
            color: white;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .detail-btn:hover {
            background: #5a6268;
            transform: translateY(-1px);
            color: white;
            text-decoration: none;
        }



        /* Status Animation */
        .status {
            transition: all 0.3s ease;
        }

        .status.updating {
            opacity: 0.7;
            transform: scale(0.95);
        }

        /* Loading Spinner */
        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Pulse Animation for Stats */
        .stat-card.updated {
            animation: pulse 0.6s ease;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* Booking Detail Modal Styles */
        .booking-detail-content {
            padding: 0;
        }

        .detail-section {
            margin-bottom: 24px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #4CAF50;
        }

        .detail-section h4 {
            margin: 0 0 16px 0;
            color: #333;
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .detail-section h4 i {
            color: #4CAF50;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .detail-item .label {
            font-size: 12px;
            color: #666;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-item .value {
            font-size: 14px;
            color: #333;
            font-weight: 500;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .status-badge.pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-badge.confirmed {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.cancelled {
            background: #f8d7da;
            color: #721c24;
        }

        /* Payment Status Styles */
        .payment-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .payment-status.paid {
            background: #d4edda;
            color: #155724;
        }

        .payment-status.pending {
            background: #fff3cd;
            color: #856404;
        }

        .payment-status.failed {
            background: #f8d7da;
            color: #721c24;
        }

        /* Additional Stat Icon Styles */
        .stat-icon.paid {
            background: #d4edda;
            color: #155724;
        }

        .stat-icon.pending-payment {
            background: #fff3cd;
            color: #856404;
        }

        .price-value {
            color: #4CAF50;
            font-weight: 600;
            font-size: 16px;
        }

        /* Responsive for detail grid */
        @media (max-width: 768px) {
            .detail-grid {
                grid-template-columns: 1fr;
            }
            
            .modal {
                max-width: 95%;
                margin: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div th:replace="~{/Layout/NavbarAdmin}"></div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="management-section">
            <div class="section-header">
                <h2><i class="fas fa-calendar-check"></i> Quản Lý Đặt Phòng Đã Thành Công</h2>
                <p style="color: #666; margin-top: 8px; font-size: 14px;">
                    <i class="fas fa-info-circle"></i> Chỉ hiển thị những đặt phòng có trạng thái "Đã đặt phòng thành công" (CONFIRMED)
                </p>
            </div>
            
            <div class="section-body">
                <!-- Stats Overview -->
                <div class="stats-overview">
                    <div class="stat-card" id="totalBookings">
                        <div class="stat-header">
                            <div class="stat-title">Tổng Đặt Phòng Thành Công</div>
                            <div class="stat-icon total">
                                <i class="fas fa-calendar-alt"></i>
                            </div>
                        </div>
                        <div class="stat-value" th:text="${stats != null ? stats.totalBookings : #lists.size(bookings)}">0</div>
                    </div>
                    
                    <div class="stat-card" id="confirmedBookings">
                        <div class="stat-header">
                            <div class="stat-title">Đã Xác Nhận (CONFIRMED)</div>
                            <div class="stat-icon confirmed">
                                <i class="fas fa-check-circle"></i>
                            </div>
                        </div>
                        <div class="stat-value" th:text="${stats != null ? stats.confirmedBookings : #lists.size(bookings.?[bookingStatus == 'CONFIRMED'])}">0</div>
                    </div>
                    
                    <div class="stat-card" id="pendingBookings" style="display: none;">
                        <div class="stat-header">
                            <div class="stat-title">Chờ Xác Nhận</div>
                            <div class="stat-icon pending">
                                <i class="fas fa-clock"></i>
                            </div>
                        </div>
                        <div class="stat-value" th:text="${stats != null ? stats.pendingBookings : #lists.size(bookings.?[bookingStatus == 'PENDING'])}">0</div>
                    </div>
                    
                    <div class="stat-card" id="cancelledBookings" style="display: none;">
                        <div class="stat-header">
                            <div class="stat-title">Đã Hủy</div>
                            <div class="stat-icon cancelled">
                                <i class="fas fa-times-circle"></i>
                            </div>
                        </div>
                        <div class="stat-value" th:text="${stats != null ? stats.cancelledBookings : #lists.size(bookings.?[bookingStatus == 'CANCELLED'])}">0</div>
                    </div>
                    
                    <div class="stat-card" id="paidBookings">
                        <div class="stat-header">
                            <div class="stat-title">Đã Thanh Toán</div>
                            <div class="stat-icon paid">
                                <i class="fas fa-credit-card"></i>
                            </div>
                        </div>
                        <div class="stat-value" th:text="${stats != null ? stats.paidBookings : #lists.size(bookings.?[paymentStatus == 'PAID'])}">0</div>
                    </div>
                    
                    <div class="stat-card" id="pendingPaymentBookings">
                        <div class="stat-header">
                            <div class="stat-title">Chờ Thanh Toán Tại KS</div>
                            <div class="stat-icon pending-payment">
                                <i class="fas fa-clock"></i>
                            </div>
                        </div>
                        <div class="stat-value" th:text="${stats != null ? stats.pendingPaymentBookings : #lists.size(bookings.?[paymentStatus == 'PENDING'])}">0</div>
                    </div>
                </div>

                <div class="management-header">
                    <div class="search-filter">
                        <input type="text" id="searchInput" placeholder="Tìm kiếm khách hàng..." oninput="filterBookings()">
                        <select id="statusFilter" onchange="filterBookings()">
                            <option value="all">Tất Cả Trạng Thái</option>
                            <option value="confirmed">Đã Xác Nhận (CONFIRMED)</option>
                        </select>
                        <select id="paymentFilter" onchange="filterBookings()">
                            <option value="all">Tất Cả Thanh Toán</option>
                            <option value="paid">Đã Thanh Toán</option>
                            <option value="pending-payment">Chờ Thanh Toán</option>
                            <option value="failed">Thanh Toán Thất Bại</option>
                        </select>
                        <input type="date" id="dateFilter" onchange="filterBookings()">
                    </div>
                </div>

                <div class="booking-table">
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Mã Đặt Phòng</th>
                                    <th>Khách Hàng</th>
                                    <th>Phòng</th>
                                    <th>Ngày Đặt</th>
                                    <th>Giá</th>
                                    <th>Trạng Thái</th>
                                    <th>Thanh Toán</th>
                                    <th>Thao Tác</th>
                                </tr>
                            </thead>
                            <tbody id="bookingTableBody">
                                <tr th:each="booking : ${bookings}" 
                                    th:data-status="${booking.bookingStatus != null ? booking.bookingStatus.toLowerCase() : 'pending'}"
                                    th:data-booking-id="${booking.bookingId}">
                                    <td class="booking-id" th:text="'#' + ${booking.bookingId}">#BK001</td>
                                    <td>
                                        <div class="customer-info">
                                            <div class="customer-name" th:text="${booking.customer != null ? booking.customer.name : 'Chưa có'}">Khách hàng</div>
                                            <div class="customer-email" th:text="${booking.customer != null ? booking.customer.email : 'Chưa có'}">email@example.com</div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="room-info">
                                            <div class="room-name" th:text="${booking.room != null ? booking.room.roomNumber : 'Chưa có'}">Tên phòng</div>
                                            <div class="room-type" th:text="${booking.room != null && booking.room.type != null ? booking.room.type.description : 'Chưa có'}">Loại phòng</div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="date-range">
                                            <div class="check-in" th:text="'Nhận: ' + ${booking.checkInDate != null ? #temporals.format(booking.checkInDate, 'dd/MM/yyyy') : 'N/A'}">Nhận: 25/05/2025</div>
                                            <div class="check-out" th:text="'Trả: ' + ${booking.checkOutDate != null ? #temporals.format(booking.checkOutDate, 'dd/MM/yyyy') : 'N/A'}">Trả: 27/05/2025</div>
                                        </div>
                                    </td>
                                    <td class="price" th:text="${booking.totalPrice != null ? #numbers.formatDecimal(booking.totalPrice, 0, 'COMMA', 0, 'POINT') + ' ₫' : '0 ₫'}">3,000,000 ₫</td>
                                    <td>
                                        <span th:class="'status ' + ${booking.bookingStatus != null ? booking.bookingStatus.toLowerCase() : 'pending'}" 
                                              th:text="${booking.bookingStatus == 'PENDING' ? 'Chờ Xác Nhận' : 
                                                        booking.bookingStatus == 'CONFIRMED' ? 'Đã Xác Nhận' : 
                                                        booking.bookingStatus == 'CANCELLED' ? 'Đã Hủy' : 
                                                        booking.bookingStatus != null ? booking.bookingStatus : 'Chưa xác định'}">
                                            Trạng thái
                                        </span>
                                    </td>
                                    <td>
                                        <span th:class="'payment-status ' + ${booking.paymentStatus != null ? booking.paymentStatus.toLowerCase() : 'pending'}" 
                                              th:attr="data-payment-method=${booking.paymentMethod}"
                                              th:text="${booking.paymentStatus == 'PAID' ? 'Đã thanh toán' : 
                                                        booking.paymentStatus == 'PENDING' ? 'Chờ thanh toán tại khách sạn' : 
                                                        booking.paymentStatus == 'FAILED' ? 'Thanh toán thất bại' : 
                                                        'Chưa thanh toán'}">
                                            Trạng thái thanh toán
                                        </span>
                                    </td>
                                                                            <td>
                                            <div class="actions">
                                                <a th:href="@{/admin/bookings/{bookingId}(bookingId=${booking.bookingId})}" class="detail-btn">
                                                    <i class="fas fa-eye"></i> Chi tiết
                                                </a>
                                            </div>
                                        </td>
                                </tr>
                                
                                <!-- Hiển thị thông báo khi không có dữ liệu -->
                                <tr th:if="${#lists.isEmpty(bookings)}">
                                    <td colspan="8" style="text-align: center; padding: 40px; color: #666;">
                                        <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;"></i>
                                        <div style="font-size: 16px; margin-bottom: 8px;">Chưa có đặt phòng thành công nào</div>
                                        <div style="font-size: 14px; opacity: 0.7;">Chỉ hiển thị những đặt phòng có trạng thái "Đã đặt phòng thành công" (CONFIRMED)</div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<!-- Modal Container -->
<div class="modal-overlay" id="modalOverlay">
    <div class="modal" id="modal">
        <div class="modal-header">
            <h3 class="modal-title" id="modalTitle">
                <i class="fas fa-info-circle"></i>
                Xác nhận thao tác
            </h3>
        </div>
        <div class="modal-body">
            <p class="modal-message" id="modalMessage">
                Bạn có chắc chắn muốn thực hiện thao tác này?
            </p>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal()">Hủy</button>
                <button class="btn btn-primary" id="modalConfirmBtn">Xác nhận</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Toast Notification System
    function showToast(type, title, message, duration = 4000) {
        const toastContainer = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        
        const icons = {
            success: 'fas fa-check-circle',
            error: 'fas fa-exclamation-circle',
            warning: 'fas fa-exclamation-triangle',
            info: 'fas fa-info-circle'
        };
        
        toast.innerHTML = `
            <i class="toast-icon ${icons[type]}"></i>
            <div class="toast-content">
                <div class="toast-title">${title}</div>
                <div class="toast-message">${message}</div>
            </div>
            <button class="toast-close" onclick="removeToast(this.parentElement)">
                <i class="fas fa-times"></i>
            </button>
        `;
        
        toastContainer.appendChild(toast);
        
        // Auto remove after duration
        setTimeout(() => {
            removeToast(toast);
        }, duration);
    }
    
    function removeToast(toast) {
        if (toast && toast.parentElement) {
            toast.style.animation = 'slideOut 0.3s ease forwards';
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.parentElement.removeChild(toast);
                }
            }, 300);
        }
    }

    // Modal System
    function showModal(title, message, confirmText = 'Xác nhận', confirmCallback = null) {
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalConfirmBtn = document.getElementById('modalConfirmBtn');
        const modalOverlay = document.getElementById('modalOverlay');
        
        modalTitle.innerHTML = title;
        modalMessage.textContent = message;
        modalConfirmBtn.textContent = confirmText;
        
        modalOverlay.style.display = 'flex';
        setTimeout(() => {
            modal.classList.add('show');
        }, 10);
        
        // Set up confirm callback
        modalConfirmBtn.onclick = () => {
            closeModal();
            if (confirmCallback) {
                confirmCallback();
            }
        };
    }
    
    function showDetailModal(content, title) {
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalConfirmBtn = document.getElementById('modalConfirmBtn');
        const modalOverlay = document.getElementById('modalOverlay');
        
        modalTitle.innerHTML = title;
        modalMessage.innerHTML = content;
        modalConfirmBtn.textContent = 'Đóng';
        modalConfirmBtn.className = 'btn btn-primary';
        
        modalOverlay.style.display = 'flex';
        setTimeout(() => {
            modal.classList.add('show');
        }, 10);
        
        // Set up close callback
        modalConfirmBtn.onclick = () => {
            closeModal();
        };
    }
    
    function closeModal() {
        const modal = document.getElementById('modal');
        const modalOverlay = document.getElementById('modalOverlay');
        
        modal.classList.remove('show');
        setTimeout(() => {
            modalOverlay.style.display = 'none';
        }, 300);
    }

    // Debug function to show current booking statuses
    function debugBookingStatuses() {
        console.log('🔍 Debug: Current booking statuses in DOM');
        
        const rows = document.querySelectorAll('#bookingTableBody tr[data-booking-id]');
        const statusCounts = { confirmed: 0, pending: 0, cancelled: 0 };
        
        rows.forEach(row => {
            const bookingId = row.getAttribute('data-booking-id');
            const dataStatus = row.getAttribute('data-status');
            const statusSpan = row.querySelector('.status');
            const statusText = statusSpan ? statusSpan.textContent : 'N/A';
            
            console.log(`Booking #${bookingId}: data-status="${dataStatus}", text="${statusText}"`);
            
            if (dataStatus && statusCounts.hasOwnProperty(dataStatus)) {
                statusCounts[dataStatus]++;
            }
        });
        
        console.log('📊 DOM Status Counts:', statusCounts);
        return statusCounts;
    }

    // Helper function to validate and fix DOM inconsistencies
    function validateAndFixDOMStatus() {
        console.log('🔍 Validating DOM status consistency...');
        
        const rows = document.querySelectorAll('#bookingTableBody tr[data-booking-id]');
        let fixedCount = 0;
        
        rows.forEach(row => {
            const dataStatus = row.getAttribute('data-status');
            const statusSpan = row.querySelector('.status');
            
            if (statusSpan && dataStatus) {
                const expectedClass = `status ${dataStatus}`;
                if (!statusSpan.className.includes(dataStatus)) {
                    console.log(`🔧 Fixing inconsistent status for row ${row.getAttribute('data-booking-id')}: ${statusSpan.className} -> ${expectedClass}`);
                    statusSpan.className = expectedClass;
                    fixedCount++;
                }
            }
        });
        
        if (fixedCount > 0) {
            console.log(`✅ Fixed ${fixedCount} inconsistent status elements`);
        } else {
            console.log('✅ All DOM status elements are consistent');
        }
    }

    // Helper function to update booking status consistently
    function updateBookingStatus(row, newStatus) {
        const statusSpan = row.querySelector('.status');
        const statusText = newStatus === 'CONFIRMED' ? 'Đã Xác Nhận' : 
                          newStatus === 'PENDING' ? 'Chờ Xác Nhận' : 
                          newStatus === 'CANCELLED' ? 'Đã Hủy' : newStatus;
        
        // Update the status span
        statusSpan.className = `status ${newStatus.toLowerCase()}`;
        statusSpan.textContent = statusText;
        
        // Update data-status attribute consistently
        row.setAttribute('data-status', newStatus.toLowerCase());
        
        console.log(`🔄 Updated booking status to: ${newStatus} (${statusText})`);
    }

    // Update Stats
    function updateStats() {
        console.log('🔄 Updating stats...');
        
        // Debug current DOM statuses
        debugBookingStatuses();
        
        // Validate and fix DOM inconsistencies first
        validateAndFixDOMStatus();
        
        // Fetch fresh data from API
        fetch('/api/admin/bookings')
            .then(response => {
                console.log('📡 API Response status:', response.status);
                return response.json();
            })
            .then(bookings => {
                console.log('📊 Raw bookings data:', bookings);
                
                if (Array.isArray(bookings)) {
                    const totalBookings = bookings.length;
                    
                    // Debug: Log each booking's status
                    console.log('🔍 Booking statuses:');
                    bookings.forEach((booking, index) => {
                        console.log(`Booking ${index + 1}: ID=${booking.bookingId}, Status=${booking.bookingStatus}, Payment=${booking.paymentStatus}`);
                    });
                    
                    // Tất cả booking đều là CONFIRMED (đã được filter ở backend)
                    const confirmedBookings = bookings; // Tất cả booking đều là CONFIRMED
                    const paidBookings = bookings.filter(b => 
                        b.paymentStatus && b.paymentStatus.toUpperCase() === 'PAID'
                    );
                    const pendingPaymentBookings = bookings.filter(b => 
                        b.paymentStatus && b.paymentStatus.toUpperCase() === 'PENDING'
                    );
                    
                    console.log('📈 Filtered results (chỉ CONFIRMED):');
                    console.log('- Total:', totalBookings);
                    console.log('- Confirmed:', confirmedBookings.length, confirmedBookings.map(b => b.bookingId));
                    console.log('- Paid:', paidBookings.length);
                    console.log('- Pending Payment:', pendingPaymentBookings.length);
                    
                    // Update values with animation
                    updateStatValue('totalBookings', totalBookings);
                    updateStatValue('confirmedBookings', confirmedBookings.length);
                    updateStatValue('paidBookings', paidBookings.length);
                    updateStatValue('pendingPaymentBookings', pendingPaymentBookings.length);
                    
                    console.log('✅ Stats updated successfully');
                } else {
                    console.error('❌ Bookings data is not an array:', typeof bookings);
                }
            })
            .catch(error => {
                console.error('❌ Error updating stats:', error);
                // Fallback to DOM-based counting if API fails
                console.log('🔄 Falling back to DOM-based counting...');
                
                const totalBookings = document.querySelectorAll('#bookingTableBody tr[data-booking-id]').length;
                const confirmedBookings = document.querySelectorAll('#bookingTableBody tr[data-status="confirmed"]').length;
                const paidBookings = document.querySelectorAll('#bookingTableBody tr .payment-status.paid').length;
                const pendingPaymentBookings = document.querySelectorAll('#bookingTableBody tr .payment-status.pending').length;
                
                console.log('📊 DOM-based results (chỉ CONFIRMED):');
                console.log('- Total:', totalBookings);
                console.log('- Confirmed:', confirmedBookings);
                console.log('- Paid:', paidBookings);
                console.log('- Pending Payment:', pendingPaymentBookings);
                
                updateStatValue('totalBookings', totalBookings);
                updateStatValue('confirmedBookings', confirmedBookings);
                updateStatValue('paidBookings', paidBookings);
                updateStatValue('pendingPaymentBookings', pendingPaymentBookings);
            });
    }
    
    function updateStatValue(statId, newValue) {
        const statCard = document.getElementById(statId);
        const statValue = statCard.querySelector('.stat-value');
        const currentValue = parseInt(statValue.textContent);
        
        if (currentValue !== newValue) {
            statCard.classList.add('updated');
            statValue.textContent = newValue;
            
            setTimeout(() => {
                statCard.classList.remove('updated');
            }, 600);
        }
    }

    // Mobile Menu Toggle
    function toggleMobileMenu() {
        const mobileMenu = document.getElementById('mobileMenu');
        const toggleBtn = document.querySelector('.mobile-toggle i');
        
        mobileMenu.classList.toggle('active');
        
        if (mobileMenu.classList.contains('active')) {
            toggleBtn.className = 'fas fa-times';
        } else {
            toggleBtn.className = 'fas fa-bars';
        }
    }

    // Close mobile menu when clicking outside
    document.addEventListener('click', function(event) {
        const mobileMenu = document.getElementById('mobileMenu');
        const toggleBtn = document.querySelector('.mobile-toggle');
        
        if (!mobileMenu.contains(event.target) && !toggleBtn.contains(event.target)) {
            mobileMenu.classList.remove('active');
            document.querySelector('.mobile-toggle i').className = 'fas fa-bars';
        }
    });

    // Filter Bookings
    function filterBookings() {
        const searchInput = document.getElementById('searchInput').value.toLowerCase();
        const statusFilter = document.getElementById('statusFilter').value;
        const paymentFilter = document.getElementById('paymentFilter').value;
        const dateFilter = document.getElementById('dateFilter').value;
        const rows = document.querySelectorAll('#bookingTableBody tr');

        rows.forEach(row => {
            const customerName = row.querySelector('.customer-name').textContent.toLowerCase();
            const status = row.getAttribute('data-status');
            const paymentStatusElement = row.querySelector('.payment-status');
            let paymentStatus = 'pending';
            
            if (paymentStatusElement) {
                const paymentClass = paymentStatusElement.getAttribute('class');
                if (paymentClass.includes('paid')) {
                    paymentStatus = 'paid';
                } else if (paymentClass.includes('pending')) {
                    paymentStatus = 'pending-payment';
                } else if (paymentClass.includes('failed')) {
                    paymentStatus = 'failed';
                }
            }
            
            const checkInDate = row.querySelector('.check-in').textContent;

            const matchesSearch = customerName.includes(searchInput);
            
            // Logic filter status - chỉ có booking CONFIRMED được hiển thị
            let matchesStatus = statusFilter === 'all';
            if (statusFilter === 'confirmed') {
                matchesStatus = status === 'confirmed';
            }
            // Tất cả booking hiển thị đều là CONFIRMED, nên không cần filter pending/cancelled
            
            const matchesPayment = paymentFilter === 'all' || paymentStatus === paymentFilter;
            const matchesDate = !dateFilter || checkInDate.includes(dateFilter);

            if (matchesSearch && matchesStatus && matchesPayment && matchesDate) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }



    // Booking Actions
    function viewBooking(button, bookingId) {
        const row = button.closest('tr');
        // Use bookingId from parameter if provided, otherwise get from row
        if (!bookingId) {
            bookingId = row.getAttribute('data-booking-id');
        }
        const customerName = row.querySelector('.customer-name').textContent;
        const customerEmail = row.querySelector('.customer-email').textContent;
        const roomName = row.querySelector('.room-name').textContent;
        const roomType = row.querySelector('.room-type').textContent;
        const checkIn = row.querySelector('.check-in').textContent;
        const checkOut = row.querySelector('.check-out').textContent;
        const price = row.querySelector('.price').textContent;
        const status = row.querySelector('.status').textContent;
        const statusClass = row.querySelector('.status').className;
        
        // Show loading modal first
        showDetailModal(`
            <div style="text-align: center; padding: 40px;">
                <div class="loading-spinner" style="margin: 0 auto 20px;"></div>
                <div>Đang tải thông tin chi tiết...</div>
            </div>
        `, `Chi tiết đặt phòng #${bookingId}`);
        
        // Fetch detailed booking information from API
        fetch(`/api/admin/bookings/${bookingId}`)
            .then(response => response.json())
            .then(booking => {
                if (booking.message) {
                    // Error occurred
                    showDetailModal(`
                        <div style="text-align: center; padding: 40px; color: #f44336;">
                            <i class="fas fa-exclamation-circle" style="font-size: 48px; margin-bottom: 16px;"></i>
                            <div style="font-size: 16px; margin-bottom: 8px;">Không thể tải thông tin</div>
                            <div style="font-size: 14px;">${booking.message}</div>
                        </div>
                    `, `Chi tiết đặt phòng #${bookingId}`);
                } else {
                    // Success - show detailed information
                    const modalContent = `
                        <div class="booking-detail-content">
                            <div class="detail-section">
                                <h4><i class="fas fa-info-circle"></i> Thông Tin Đặt Phòng</h4>
                                <div class="detail-grid">
                                    <div class="detail-item">
                                        <span class="label">Mã đặt phòng:</span>
                                        <span class="value">#${booking.bookingId}</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="label">Trạng thái:</span>
                                        <span class="value status-badge ${booking.bookingStatus ? booking.bookingStatus.toLowerCase() : 'pending'}">${booking.bookingStatus || 'Chưa xác định'}</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="label">Ngày đặt:</span>
                                        <span class="value">${booking.bookingDate ? new Date(booking.bookingDate).toLocaleDateString('vi-VN') : 'Chưa có'}</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="label">Tổng tiền:</span>
                                        <span class="value price-value">${booking.totalPrice ? new Intl.NumberFormat('vi-VN').format(booking.totalPrice) : '0'} ₫</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="detail-section">
                                <h4><i class="fas fa-user"></i> Thông Tin Khách Hàng</h4>
                                <div class="detail-grid">
                                    <div class="detail-item">
                                        <span class="label">Họ tên:</span>
                                        <span class="value">${booking.customerName || 'Chưa có'}</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="label">Email:</span>
                                        <span class="value">${booking.customerEmail || 'Chưa có'}</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="label">Số điện thoại:</span>
                                        <span class="value">${booking.customerPhone || 'Chưa cập nhật'}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="detail-section">
                                <h4><i class="fas fa-bed"></i> Thông Tin Phòng</h4>
                                <div class="detail-grid">
                                    <div class="detail-item">
                                        <span class="label">Tên phòng:</span>
                                        <span class="value">${booking.roomNumber || 'Chưa có'}</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="label">Loại phòng:</span>
                                        <span class="value">${booking.roomType || 'Chưa có'}</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="label">Số lượng phòng:</span>
                                        <span class="value">${booking.roomQuantity || 1}</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="label">Ngày nhận:</span>
                                        <span class="value">${booking.checkInDate ? new Date(booking.checkInDate).toLocaleDateString('vi-VN') : 'Chưa có'}</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="label">Ngày trả:</span>
                                        <span class="value">${booking.checkOutDate ? new Date(booking.checkOutDate).toLocaleDateString('vi-VN') : 'Chưa có'}</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="label">Số đêm:</span>
                                        <span class="value">${booking.checkInDate && booking.checkOutDate ? Math.ceil((new Date(booking.checkOutDate) - new Date(booking.checkInDate)) / (1000 * 60 * 60 * 24)) : 0} đêm</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="detail-section">
                                <h4><i class="fas fa-credit-card"></i> Thông Tin Thanh Toán</h4>
                                <div class="detail-grid">
                                    <div class="detail-item">
                                        <span class="label">Phương thức:</span>
                                        <span class="value">${booking.paymentMethod || 'Chưa xác định'}</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="label">Trạng thái thanh toán:</span>
                                        <span class="value status-badge ${booking.paymentStatus === 'PAID' ? 'confirmed' : 'pending'}">${booking.paymentStatus ? (booking.paymentStatus === 'PAID' ? 'Đã thanh toán' : (booking.paymentStatus === 'PENDING' ? 'Chờ thanh toán tại khách sạn' : 'Chưa thanh toán')) : 'Chưa xác định'}</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="label">Ngày thanh toán:</span>
                                        <span class="value">${booking.paidDate ? new Date(booking.paidDate).toLocaleDateString('vi-VN') : 'Chưa thanh toán'}</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="label">Mã giao dịch:</span>
                                        <span class="value">${booking.bookingId ? 'TXN' + booking.bookingId.toString().padStart(8, '0') : 'Chưa có'}</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="label">Thông báo:</span>
                                        <span class="value">${booking.paymentStatus === 'PAID' ? 'Đã thanh toán, chờ nhận phòng' : (booking.paymentStatus === 'PENDING' ? 'Đặt phòng thành công! Chờ thanh toán tại khách sạn' : 'Chưa xác định')}</span>
                                    </div>
                                </div>
                            </div>
                            
                            ${booking.specialRequests ? `
                            <div class="detail-section">
                                <h4><i class="fas fa-comment"></i> Yêu Cầu Đặc Biệt</h4>
                                <div class="detail-grid">
                                    <div class="detail-item" style="grid-column: 1 / -1;">
                                        <span class="label">Nội dung:</span>
                                        <span class="value">${booking.specialRequests}</span>
                                    </div>
                                </div>
                            </div>
                            ` : ''}
                        </div>
                    `;
                    
                    showDetailModal(modalContent, `Chi tiết đặt phòng #${bookingId}`);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showDetailModal(`
                    <div style="text-align: center; padding: 40px; color: #f44336;">
                        <i class="fas fa-exclamation-circle" style="font-size: 48px; margin-bottom: 16px;"></i>
                        <div style="font-size: 16px; margin-bottom: 8px;">Lỗi kết nối</div>
                        <div style="font-size: 14px;">Không thể kết nối đến máy chủ</div>
                    </div>
                `, `Chi tiết đặt phòng #${bookingId}`);
            });
    }

    function confirmBooking(button, bookingId) {
        const row = button.closest('tr');
        const customerName = row.querySelector('.customer-name').textContent;
        
        showModal(
            '<i class="fas fa-check-circle"></i> Xác nhận đặt phòng',
            `Bạn có chắc chắn muốn xác nhận đặt phòng #${bookingId} của khách hàng ${customerName}?`,
            'Xác nhận',
            () => {
                // Show loading state
                const statusSpan = row.querySelector('.status');
                statusSpan.classList.add('updating');
                statusSpan.innerHTML = '<span class="loading-spinner"></span>Đang xử lý...';
                
                // Call API to update status
                fetch(`/api/admin/bookings/${bookingId}/status`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        status: 'CONFIRMED'
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.message) {
                        // Error occurred
                        showToast('error', 'Lỗi', data.message, 3000);
                        statusSpan.classList.remove('updating');
                        statusSpan.innerHTML = 'Chờ Xác Nhận';
                    } else {
                        // Success
                        updateBookingStatus(row, 'CONFIRMED');
                        statusSpan.classList.remove('updating');
                        
                        // Remove confirm button
                        button.remove();
                        
                        // Update stats
                        updateStats();
                        
                        // Show success message
                        showToast('success', 'Thành công', `Đã xác nhận đặt phòng #${bookingId}`, 3000);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('error', 'Lỗi', 'Không thể kết nối đến máy chủ', 3000);
                    statusSpan.classList.remove('updating');
                    // Restore original status
                    const originalStatus = row.getAttribute('data-status') === 'pending' ? 'PENDING' : 'CONFIRMED';
                    updateBookingStatus(row, originalStatus);
                });
            }
        );
    }

    function confirmPayment(button, bookingId) {
        const row = button.closest('tr');
        const customerName = row.querySelector('.customer-name').textContent;
        
        showModal(
            '<i class="fas fa-credit-card"></i> Xác nhận thanh toán',
            `Bạn có chắc chắn muốn xác nhận thanh toán cho đặt phòng #${bookingId} của khách hàng ${customerName}?`,
            'Xác nhận thanh toán',
            () => {
                // Show loading state
                const paymentStatusSpan = row.querySelector('.payment-status');
                paymentStatusSpan.classList.add('updating');
                paymentStatusSpan.innerHTML = '<span class="loading-spinner"></span>Đang xử lý...';
                
                // Call API to confirm payment
                fetch(`/api/admin/bookings/${bookingId}/confirm-payment`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.message && data.message.includes('Lỗi')) {
                        // Error occurred
                        showToast('error', 'Lỗi', data.message, 3000);
                        paymentStatusSpan.classList.remove('updating');
                        paymentStatusSpan.innerHTML = 'Chờ thanh toán';
                    } else {
                        // Success
                        paymentStatusSpan.className = 'status-badge confirmed';
                        paymentStatusSpan.textContent = 'Đã thanh toán';
                        paymentStatusSpan.classList.remove('updating');
                        
                        // Remove confirm payment button
                        button.remove();
                        
                        // Update stats
                        updateStats();
                        
                        // Show success message
                        showToast('success', 'Thành công', `Đã xác nhận thanh toán cho đặt phòng #${bookingId}`, 3000);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('error', 'Lỗi', 'Không thể kết nối đến máy chủ', 3000);
                    paymentStatusSpan.classList.remove('updating');
                    paymentStatusSpan.innerHTML = 'Chờ thanh toán';
                });
            }
        );
    }

    function confirmPaymentAtHotel(button, bookingId) {
        const row = button.closest('tr');
        const customerName = row.querySelector('.customer-name').textContent;
        
        showModal(
            '<i class="fas fa-money-bill-wave"></i> Xác nhận thanh toán tại khách sạn',
            `Bạn có chắc chắn muốn xác nhận thanh toán tại khách sạn cho đặt phòng #${bookingId} của khách hàng ${customerName}?`,
            'Xác nhận thanh toán',
            () => {
                // Show loading state
                const paymentStatusSpan = row.querySelector('.payment-status');
                paymentStatusSpan.classList.add('updating');
                paymentStatusSpan.innerHTML = '<span class="loading-spinner"></span>Đang xử lý...';
                
                // Call API to confirm payment at hotel
                fetch(`/api/admin/bookings/${bookingId}/confirm-payment-hotel`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.message && data.message.includes('Lỗi')) {
                        // Error occurred
                        showToast('error', 'Lỗi', data.message, 3000);
                        paymentStatusSpan.classList.remove('updating');
                        paymentStatusSpan.innerHTML = 'Chờ thanh toán tại khách sạn';
                    } else {
                        // Success
                        paymentStatusSpan.className = 'status-badge confirmed';
                        paymentStatusSpan.textContent = 'Đã thanh toán';
                        paymentStatusSpan.classList.remove('updating');
                        
                        // Remove confirm payment button
                        button.remove();
                        
                        // Update stats
                        updateStats();
                        
                        // Show success message
                        showToast('success', 'Thành công', `Đã xác nhận thanh toán tại khách sạn cho đặt phòng #${bookingId}`, 3000);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('error', 'Lỗi', 'Không thể kết nối đến máy chủ', 3000);
                    paymentStatusSpan.classList.remove('updating');
                    paymentStatusSpan.innerHTML = 'Chờ thanh toán tại khách sạn';
                });
            }
        );
    }

    function cancelBooking(button, bookingId) {
        const row = button.closest('tr');
        const customerName = row.querySelector('.customer-name').textContent;
        
        showModal(
            '<i class="fas fa-times-circle"></i> Hủy đặt phòng',
            `Bạn có chắc chắn muốn hủy đặt phòng #${bookingId} của khách hàng ${customerName}?`,
            'Hủy đặt phòng',
            () => {
                // Show loading state
                const statusSpan = row.querySelector('.status');
                statusSpan.classList.add('updating');
                statusSpan.innerHTML = '<span class="loading-spinner"></span>Đang xử lý...';
                
                // Call API to cancel booking
                fetch(`/api/admin/bookings/${bookingId}/cancel`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        reason: 'Hủy bởi admin'
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.message && data.message.includes('Lỗi')) {
                        // Error occurred
                        showToast('error', 'Lỗi', data.message, 3000);
                        statusSpan.classList.remove('updating');
                        statusSpan.innerHTML = row.getAttribute('data-status') === 'pending' ? 'Chờ Xác Nhận' : 'Đã Xác Nhận';
                    } else {
                        // Success
                        updateBookingStatus(row, 'CANCELLED');
                        statusSpan.classList.remove('updating');
                        
                        // Remove action buttons except view
                        const actions = row.querySelector('.actions');
                        const viewBtn = actions.querySelector('.view-btn');
                        actions.innerHTML = '';
                        actions.appendChild(viewBtn);
                        
                        // Update stats
                        updateStats();
                        
                        // Show success message
                        showToast('warning', 'Đã hủy', `Đã hủy đặt phòng #${bookingId}`, 3000);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('error', 'Lỗi', 'Không thể kết nối đến máy chủ', 3000);
                    statusSpan.classList.remove('updating');
                    // Restore original status
                    const originalStatus = row.getAttribute('data-status') === 'pending' ? 'PENDING' : 'CONFIRMED';
                    updateBookingStatus(row, originalStatus);
                });
            }
        );
    }

    // Placeholder functions for future features
    function editBooking(button, bookingId) {
        showToast('info', 'Tính năng sắp tới', 'Chức năng chỉnh sửa đặt phòng sẽ được phát triển trong phiên bản tiếp theo!', 3000);
    }

    function sendNotification(button, bookingId) {
        showToast('info', 'Tính năng sắp tới', 'Chức năng gửi thông báo sẽ được phát triển trong phiên bản tiếp theo!', 3000);
    }

    // Handle window resize
    window.addEventListener('resize', function() {
        const mobileMenu = document.getElementById('mobileMenu');
        
        if (window.innerWidth > 992) {
            mobileMenu.classList.remove('active');
            document.querySelector('.mobile-toggle i').className = 'fas fa-bars';
        }
    });

    // Keyboard navigation
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            const mobileMenu = document.getElementById('mobileMenu');
            if (mobileMenu.classList.contains('active')) {
                toggleMobileMenu();
            }
            closeModal();
        }
    });

    // Close modal when clicking overlay
    document.getElementById('modalOverlay').addEventListener('click', function(event) {
        if (event.target === this) {
            closeModal();
        }
    });

    // Initialize stats on page load
    document.addEventListener('DOMContentLoaded', function() {
        updateStats();
    });
</script>
</body>
</html>
