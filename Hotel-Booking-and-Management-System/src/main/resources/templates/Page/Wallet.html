<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.headerName}">
    <title>HotelPay Pro - Hệ Thống Ví Điện Tử Khách Sạn</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet"  th:href="@{/Css/Waller.css}">
    
</head>
<body>
    <div th:replace="~{/Layout/narbar}"></div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <div class="app-container">
        <!-- Sidebar - CHỈ CÒN PHẦN VÍ & THANH TOÁN -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="user-profile" onclick="showUserProfile()">
                    <div class="user-avatar">
                        NV
                        <div class="user-status"></div>
                    </div>
                    <div class="user-details">
                        <h3>Nguyễn Văn A</h3>
                        <p>Premium Member</p>
                    </div>
                </div>
            </div>

            <nav class="nav-menu">
                <!-- CHỈ CÒN PHẦN VÍ & THANH TOÁN -->
                <div class="nav-section">
                    <div class="nav-section-title">Ví & Thanh toán</div>
                    <a href="#" class="nav-item active" data-page="wallet">
                        <div class="nav-icon"><i class="fas fa-wallet"></i></div>
                        <span>Ví của tôi</span>
                    </a>
                    <a href="#" class="nav-item" data-page="transactions">
                        <div class="nav-icon"><i class="fas fa-exchange-alt"></i></div>
                        <span>Giao dịch</span>
                        <span class="nav-badge">12</span>
                    </a>
                    <a href="#" class="nav-item" data-page="cards">
                        <div class="nav-icon"><i class="fas fa-credit-card"></i></div>
                        <span>Thẻ & Tài khoản</span>
                    </a>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Bar -->
            <div class="top-bar">
                <div class="page-header">
                    <h1 id="pageTitle">Dashboard Tổng quan</h1>
                    <p id="pageSubtitle">Quản lý ví điện tử và theo dõi hoạt động của bạn</p>
                </div>
                <div class="top-bar-actions">
                    <div class="search-box">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" class="search-input" placeholder="Tìm kiếm giao dịch, khách sạn...">
                    </div>
                    <button class="notification-btn" onclick="showNotifications()">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge">5</span>
                    </button>
                    <button class="action-button" onclick="openTopUpModal()">
                        <i class="fas fa-plus"></i>
                        <span>Nạp tiền</span>
                    </button>
                </div>
            </div>

            <!-- Dashboard Content - TOÀN BỘ NỘI DUNG GỐC -->
            <div id="dashboardContent">
                <!-- Stats Row -->
                <div class="dashboard-grid">
                    <div class="stats-row">
                        <div class="stat-card" onclick="showBalanceDetails()">
                            <div class="stat-header">
                                <div>
                                    <div class="stat-title">Số dư khả dụng</div>
                                    <div class="stat-value" id="balanceValue" th:text="${walletData != null ? #numbers.formatDecimal(walletData.balance, 0, 'COMMA', 0, 'POINT') + ' ₫' : '0 ₫'}">2,450,000₫</div>
                                    <div class="stat-change positive">
                                        <i class="fas fa-arrow-up"></i>
                                        <span>+12.5% tháng này</span>
                                    </div>
                                </div>
                                <div class="stat-icon">
                                    <i class="fas fa-wallet"></i>
                                </div>
                            </div>
                        </div>

                        <div class="stat-card" onclick="showSpendingDetails()">
                            <div class="stat-header">
                                <div>
                                    <div class="stat-title">Chi tiêu tháng này</div>
                                    <div class="stat-value" th:text="${walletData != null ? #numbers.formatDecimal(walletData.monthlySpending, 0, 'COMMA', 0, 'POINT') + ' ₫' : '0 ₫'}">4,750,000₫</div>
                                    <div class="stat-change negative">
                                        <i class="fas fa-arrow-down"></i>
                                        <span>-8.2% so với tháng trước</span>
                                    </div>
                                </div>
                                <div class="stat-icon">
                                    <i class="fas fa-chart-line"></i>
                                </div>
                            </div>
                        </div>

                        <div class="stat-card" onclick="showBookingStats()">
                            <div class="stat-header">
                                <div>
                                    <div class="stat-title">Đặt phòng thành công</div>
                                    <div class="stat-value" th:text="${walletData != null ? walletData.totalTransactions : 0}">24</div>
                                    <div class="stat-change positive">
                                        <i class="fas fa-arrow-up"></i>
                                        <span>+6 đặt phòng mới</span>
                                    </div>
                                </div>
                                <div class="stat-icon">
                                    <i class="fas fa-bed"></i>
                                </div>
                            </div>
                        </div>

                        <div class="stat-card" onclick="showRewardsDetails()">
                            <div class="stat-header">
                                <div>
                                    <div class="stat-title">Điểm thưởng</div>
                                    <div class="stat-value" th:text="${walletData != null ? walletData.rewardsPoints : 0}">3,250</div>
                                    <div class="stat-change positive">
                                        <i class="fas fa-arrow-up"></i>
                                        <span>+450 điểm tuần này</span>
                                    </div>
                                </div>
                                <div class="stat-icon">
                                    <i class="fas fa-star"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Balance Card -->
                    <div class="balance-card" onclick="showBalanceDetails()">
                        <div class="balance-header">
                            <div>
                                <div class="balance-title">Tổng số dư tài khoản</div>
                                <div class="balance-subtitle">Cập nhật real-time</div>
                            </div>
                            <button class="balance-menu" onclick="event.stopPropagation(); showBalanceMenu()">
                                <i class="fas fa-ellipsis-h"></i>
                            </button>
                        </div>
                        <div class="balance-amount" id="mainBalance" th:text="${walletData != null ? #numbers.formatDecimal(walletData.balance, 0, 'COMMA', 0, 'POINT') + ' ₫' : '0 ₫'}">2,450,000₫</div>
                        <div class="balance-details">
                            <div class="balance-change">
                                <i class="fas fa-trending-up"></i>
                                <span>+12.5% so với tháng trước</span>
                            </div>
                            <div class="balance-actions">
                                <button class="balance-action" onclick="event.stopPropagation(); openTopUpModal()">
                                    <i class="fas fa-plus"></i>
                                    <span>Nạp tiền</span>
                                </button>
                                <button class="balance-action" onclick="event.stopPropagation(); openWithdrawModal()">
                                    <i class="fas fa-minus"></i>
                                    <span>Rút tiền</span>
                                </button>
                                <button class="balance-action" onclick="event.stopPropagation(); openTransferModal()">
                                    <i class="fas fa-exchange-alt"></i>
                                    <span>Chuyển</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="quick-actions">
                        <h3>
                            <i class="fas fa-bolt"></i>
                            Thao tác nhanh
                        </h3>
                        <div class="actions-grid">
                            <button class="action-btn" onclick="openTopUpModal()">
                                <div class="action-icon"><i class="fas fa-plus-circle"></i></div>
                                <span>Nạp tiền</span>
                            </button>
                            <button class="action-btn" onclick="openWithdrawModal()">
                                <div class="action-icon"><i class="fas fa-minus-circle"></i></div>
                                <span>Rút tiền</span>
                            </button>
                            <button class="action-btn" onclick="openTransferModal()">
                                <div class="action-icon"><i class="fas fa-exchange-alt"></i></div>
                                <span>Chuyển khoản</span>
                            </button>
                            <button class="action-btn" onclick="showHistory()">
                                <div class="action-icon"><i class="fas fa-history"></i></div>
                                <span>Lịch sử</span>
                            </button>
                            <button class="action-btn" onclick="openBookingModal()">
                                <div class="action-icon"><i class="fas fa-bed"></i></div>
                                <span>Đặt phòng</span>
                            </button>
                            <button class="action-btn" onclick="showRewards()">
                                <div class="action-icon"><i class="fas fa-gift"></i></div>
                                <span>Ưu đãi</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Content Sections -->
                <div class="content-sections">
                    <div class="main-section">
                        <!-- Transactions Card -->
                        <div class="card">
                            <div class="card-header">
                                <div>
                                    <h2 class="card-title">
                                        <i class="fas fa-list"></i>
                                        Giao dịch gần đây
                                    </h2>
                                    <p class="card-subtitle">Theo dõi tất cả hoạt động tài chính của bạn</p>
                                </div>
                                <div class="card-actions">
                                    <button class="card-action" onclick="exportTransactions()">
                                        <i class="fas fa-download"></i>
                                        Xuất Excel
                                    </button>
                                    <button class="card-action" onclick="showAllTransactions()">
                                        Xem tất cả
                                    </button>
                                </div>
                            </div>
                            <div class="card-content">
                                <div class="transaction-filters">
                                    <button class="filter-btn active" onclick="filterTransactions('all', this)">
                                        <i class="fas fa-list"></i>
                                        Tất cả
                                    </button>
                                    <button class="filter-btn" onclick="filterTransactions('hotel', this)">
                                        <i class="fas fa-bed"></i>
                                        Khách sạn
                                    </button>
                                    <button class="filter-btn" onclick="filterTransactions('topup', this)">
                                        <i class="fas fa-plus"></i>
                                        Nạp tiền
                                    </button>
                                    <button class="filter-btn" onclick="filterTransactions('refund', this)">
                                        <i class="fas fa-undo"></i>
                                        Hoàn tiền
                                    </button>
                                    <button class="filter-btn" onclick="filterTransactions('transfer', this)">
                                        <i class="fas fa-exchange-alt"></i>
                                        Chuyển khoản
                                    </button>
                                </div>
                                
                                <div class="transactions-container" id="transactionsContainer">
                                    <div class="transaction-item" data-type="hotel" onclick="showTransactionDetails('TXN001')">
                                        <div class="transaction-icon hotel">
                                            <i class="fas fa-bed"></i>
                                            <div class="transaction-status success"></div>
                                        </div>
                                        <div class="transaction-details">
                                            <div class="transaction-title">Khách sạn Lotte Center Hanoi</div>
                                            <div class="transaction-meta">Hôm nay, 14:30 • Deluxe Room • 2 đêm</div>
                                            <div class="transaction-id">ID: TXN001</div>
                                        </div>
                                        <div class="transaction-amount">
                                            <div class="amount-value negative">-1,200,000₫</div>
                                            <div class="amount-fee">Phí: 0₫</div>
                                        </div>
                                    </div>

                                    <!-- Dynamic wallet transactions from Thymeleaf -->
                                    <div th:each="transaction : ${walletTransactions}" 
                                         th:if="${transaction.transactionType == 'TOPUP'}" 
                                         class="transaction-item" 
                                         th:data-type="topup" 
                                         th:onclick="'showTransactionDetails(' + ${transaction.id} + ')'">
                                        <div class="transaction-icon topup">
                                            <i class="fas fa-credit-card"></i>
                                            <div class="transaction-status" th:classappend="${transaction.status == 'SUCCESS' ? 'success' : (transaction.status == 'PENDING' ? 'pending' : 'failed')}"></div>
                                        </div>
                                        <div class="transaction-details">
                                            <div class="transaction-title" th:text="${transaction.description}">Nạp tiền từ Visa Platinum</div>
                                            <div class="transaction-meta" th:text="${#temporals.format(transaction.createdAt, 'dd/MM/yyyy HH:mm')} + ' • ' + ${transaction.paymentMethod != null ? transaction.paymentMethod : 'Ví HotelPay'}">Hôm qua, 09:15 • **** 1234 • Tự động</div>
                                            <div class="transaction-id" th:text="'ID: ' + ${transaction.id}">ID: TXN002</div>
                                        </div>
                                        <div class="transaction-amount">
                                            <div class="amount-value positive" th:text="'+' + ${#numbers.formatDecimal(transaction.amount, 0, 'COMMA', 0, 'POINT')} + ' ₫'">+2,000,000₫</div>
                                            <div class="amount-fee" th:text="'Phí: ' + ${#numbers.formatDecimal(transaction.fee, 0, 'COMMA', 0, 'POINT')} + ' ₫'">Phí: 5,000₫</div>
                                        </div>
                                    </div>

                                    <!-- Dynamic refund transactions from Thymeleaf -->
                                    <div th:each="booking : ${recentBookings}" 
                                         th:if="${booking.refundStatus == 'COMPLETED'}" 
                                         class="transaction-item" 
                                         th:data-type="refund" 
                                         th:onclick="'showRefundDetails(' + ${booking.bookingId} + ')'">
                                        <div class="transaction-icon refund">
                                            <i class="fas fa-undo"></i>
                                            <div class="transaction-status success"></div>
                                        </div>
                                        <div class="transaction-details">
                                            <div class="transaction-title" th:text="'Hoàn tiền hủy đặt phòng - ' + ${booking.room != null and booking.room.partner != null ? booking.room.partner.companyName : 'Khách sạn'}">Hoàn tiền hủy đặt phòng</div>
                                            <div class="transaction-meta" th:text="${#temporals.format(booking.refundDate, 'dd/MM/yyyy HH:mm')} + ' • ' + ${booking.room != null and booking.room.partner != null ? booking.room.partner.companyName : 'Khách sạn'}">2 ngày trước, 16:45 • InterContinental Hanoi</div>
                                            <div class="transaction-id" th:text="'ID: ' + ${booking.bookingId}">ID: TXN003</div>
                                        </div>
                                        <div class="transaction-amount">
                                            <div class="amount-value positive" th:text="'+' + ${#numbers.formatDecimal(booking.refundAmount, 0, 'COMMA', 0, 'POINT')} + ' ₫'">+850,000₫</div>
                                            <div class="amount-fee">Phí: 0₫</div>
                                        </div>
                                    </div>
                                    
                                    <!-- Pending refund transactions -->
                                    <div th:each="booking : ${recentBookings}" 
                                         th:if="${booking.refundStatus == 'PENDING'}" 
                                         class="transaction-item" 
                                         th:data-type="refund-pending" 
                                         th:onclick="'showPendingRefund(' + ${booking.bookingId} + ')'">
                                        <div class="transaction-icon refund">
                                            <i class="fas fa-clock"></i>
                                            <div class="transaction-status pending"></div>
                                        </div>
                                        <div class="transaction-details">
                                            <div class="transaction-title" th:text="'Chờ hoàn tiền - ' + ${booking.room != null and booking.room.partner != null ? booking.room.partner.companyName : 'Khách sạn'}">Chờ hoàn tiền</div>
                                            <div class="transaction-meta" th:text="${#temporals.format(booking.cancellationDate, 'dd/MM/yyyy HH:mm')} + ' • ' + ${booking.room != null and booking.room.partner != null ? booking.room.partner.companyName : 'Khách sạn'}">2 ngày trước, 16:45 • InterContinental Hanoi</div>
                                            <div class="transaction-id" th:text="'ID: ' + ${booking.bookingId}">ID: TXN003</div>
                                        </div>
                                        <div class="transaction-amount">
                                            <div class="amount-value pending" th:text="${#numbers.formatDecimal(booking.refundAmount, 0, 'COMMA', 0, 'POINT')} + ' ₫'">850,000₫</div>
                                            <div class="amount-fee">Chờ xử lý</div>
                                        </div>
                                    </div>

                                    <div class="transaction-item" data-type="hotel" onclick="showTransactionDetails('TXN004')">
                                        <div class="transaction-icon hotel">
                                            <i class="fas fa-umbrella-beach"></i>
                                            <div class="transaction-status success"></div>
                                        </div>
                                        <div class="transaction-details">
                                            <div class="transaction-title">Vinpearl Resort Nha Trang</div>
                                            <div class="transaction-meta">3 ngày trước, 11:20 • Ocean View Suite • 3 đêm</div>
                                            <div class="transaction-id">ID: TXN004</div>
                                        </div>
                                        <div class="transaction-amount">
                                            <div class="amount-value negative">-3,500,000₫</div>
                                            <div class="amount-fee">Phí: 0₫</div>
                                        </div>
                                    </div>

                                    <div class="transaction-item" data-type="transfer" onclick="showTransactionDetails('TXN005')">
                                        <div class="transaction-icon transfer">
                                            <i class="fas fa-exchange-alt"></i>
                                            <div class="transaction-status pending"></div>
                                        </div>
                                        <div class="transaction-details">
                                            <div class="transaction-title">Chuyển khoản cho Nguyễn Thị B</div>
                                            <div class="transaction-meta">1 tuần trước, 20:30 • 0987.654.321</div>
                                            <div class="transaction-id">ID: TXN005</div>
                                        </div>
                                        <div class="transaction-amount">
                                            <div class="amount-value negative">-500,000₫</div>
                                            <div class="amount-fee">Phí: 2,000₫</div>
                                        </div>
                                    </div>

                                    <div class="transaction-item" data-type="topup" onclick="showTransactionDetails('TXN006')">
                                        <div class="transaction-icon topup">
                                            <i class="fas fa-mobile-alt"></i>
                                            <div class="transaction-status success"></div>
                                        </div>
                                        <div class="transaction-details">
                                            <div class="transaction-title">Nạp tiền từ MoMo</div>
                                            <div class="transaction-meta">1 tuần trước, 08:30 • 0987.654.321</div>
                                            <div class="transaction-id">ID: TXN006</div>
                                        </div>
                                        <div class="transaction-amount">
                                            <div class="amount-value positive">+5,000,000₫</div>
                                            <div class="amount-fee">Phí: 0₫</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Analytics Chart -->
                        <div class="card">
                            <div class="card-header">
                                <div>
                                    <h2 class="card-title">
                                        <i class="fas fa-chart-area"></i>
                                        Biểu đồ chi tiêu
                                    </h2>
                                    <p class="card-subtitle">Phân tích xu hướng chi tiêu 6 tháng gần đây</p>
                                </div>
                                <div class="card-actions">
                                    <button class="card-action" onclick="changeChartPeriod('6m')">6 tháng</button>
                                    <button class="card-action" onclick="changeChartPeriod('1y')">1 năm</button>
                                </div>
                            </div>
                            <div class="card-content">
                                <div class="chart-container">
                                    <canvas id="spendingChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="sidebar-section">
                        <!-- Payment Methods -->
                        <div class="card">
                            <div class="card-header">
                                <div>
                                    <h3 class="card-title">
                                        <i class="fas fa-credit-card"></i>
                                        Phương thức thanh toán
                                    </h3>
                                    <p class="card-subtitle">Quản lý thẻ và ví điện tử</p>
                                </div>
                                <div class="card-actions">
                                    <button class="card-action" onclick="addPaymentMethod()">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="card-content">
                                <div class="payment-methods">
                                    <div class="payment-method active" onclick="selectPaymentMethod(this)">
                                        <div class="payment-icon visa">VISA</div>
                                        <div class="payment-details">
                                            <h4>Visa Platinum</h4>
                                            <p>**** **** **** 1234</p>
                                        </div>
                                        <div class="payment-status">
                                            <div class="status-badge verified">Đã xác thực</div>
                                            <p class="text-xs">Hết hạn: 12/26</p>
                                        </div>
                                    </div>

                                    <div class="payment-method" onclick="selectPaymentMethod(this)">
                                        <div class="payment-icon mastercard">MC</div>
                                        <div class="payment-details">
                                            <h4>MasterCard Gold</h4>
                                            <p>**** **** **** 5678</p>
                                        </div>
                                        <div class="payment-status">
                                            <div class="status-badge verified">Đã xác thực</div>
                                            <p class="text-xs">Hết hạn: 08/27</p>
                                        </div>
                                    </div>

                                    <div class="payment-method" onclick="selectPaymentMethod(this)">
                                        <div class="payment-icon momo">MOMO</div>
                                        <div class="payment-details">
                                            <h4>Ví MoMo</h4>
                                            <p>0987.654.321</p>
                                        </div>
                                        <div class="payment-status">
                                            <div class="status-badge verified">Đã liên kết</div>
                                            <p class="text-xs">Số dư: 2,500,000₫</p>
                                        </div>
                                    </div>

                                    <div class="payment-method" onclick="selectPaymentMethod(this)">
                                        <div class="payment-icon zalopay">ZALO</div>
                                        <div class="payment-details">
                                            <h4>ZaloPay</h4>
                                            <p>0987.654.321</p>
                                        </div>
                                        <div class="payment-status">
                                            <div class="status-badge pending">Chờ xác thực</div>
                                            <p class="text-xs">Cần xác thực OTP</p>
                                        </div>
                                    </div>

                                    <div class="payment-method" onclick="selectPaymentMethod(this)">
                                        <div class="payment-icon bank">BANK</div>
                                        <div class="payment-details">
                                            <h4>Vietcombank</h4>
                                            <p>**** **** **** 9876</p>
                                        </div>
                                        <div class="payment-status">
                                            <div class="status-badge verified">Đã xác thực</div>
                                            <p class="text-xs">Tài khoản chính</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Recent Bookings -->
                        <div class="card">
                            <div class="card-header">
                                <div>
                                    <h3 class="card-title">
                                        <i class="fas fa-calendar-alt"></i>
                                        Đặt phòng sắp tới
                                    </h3>
                                    <p class="card-subtitle">Lịch trình khách sạn của bạn</p>
                                </div>
                                <div class="card-actions">
                                    <button class="card-action" onclick="showAllBookings()">Xem tất cả</button>
                                </div>
                            </div>
                            <div class="card-content">
                                <div class="booking-item" onclick="showBookingDetails('BK001')">
                                    <div class="booking-image">🏨</div>
                                    <div class="booking-details">
                                        <h4>Lotte Center Hanoi</h4>
                                        <p>25-27 Tháng 7, 2025</p>
                                        <p>2 đêm • Deluxe Room</p>
                                        <div class="booking-meta">
                                            <div class="booking-status confirmed">Đã xác nhận</div>
                                            <div class="booking-price">1,200,000₫</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="booking-item" onclick="showBookingDetails('BK002')">
                                    <div class="booking-image">🏖️</div>
                                    <div class="booking-details">
                                        <h4>Vinpearl Resort Phú Quốc</h4>
                                        <p>15-18 Tháng 8, 2025</p>
                                        <p>3 đêm • Ocean View Suite</p>
                                        <div class="booking-meta">
                                            <div class="booking-status pending">Chờ thanh toán</div>
                                            <div class="booking-price">4,500,000₫</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="booking-item" onclick="showBookingDetails('BK003')">
                                    <div class="booking-image">🏨</div>
                                    <div class="booking-details">
                                        <h4>JW Marriott Hanoi</h4>
                                        <p>10-12 Tháng 9, 2025</p>
                                        <p>2 đêm • Executive Room</p>
                                        <div class="booking-meta">
                                            <div class="booking-status confirmed">Đã xác nhận</div>
                                            <div class="booking-price">2,800,000₫</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="booking-item" onclick="showBookingDetails('BK004')">
                                    <div class="booking-image">🏖️</div>
                                    <div class="booking-details">
                                        <h4>InterContinental Danang</h4>
                                        <p>20-23 Tháng 9, 2025</p>
                                        <p>3 đêm • Beach Villa</p>
                                        <div class="booking-meta">
                                            <div class="booking-status pending">Chờ xác nhận</div>
                                            <div class="booking-price">6,200,000₫</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Loyalty Program -->
                        <div class="card">
                            <div class="card-header">
                                <div>
                                    <h3 class="card-title">
                                        <i class="fas fa-crown"></i>
                                        Chương trình thành viên
                                    </h3>
                                    <p class="card-subtitle">Tích điểm và nhận ưu đãi</p>
                                </div>
                            </div>
                            <div class="card-content">
                                <div class="loyalty-status">
                                    <div class="loyalty-tier">
                                        <div class="tier-icon">👑</div>
                                        <div class="tier-info">
                                            <h4>Premium Member</h4>
                                            <p>3,250 điểm • Còn 750 điểm để lên VIP</p>
                                        </div>
                                    </div>
                                    <div class="loyalty-progress">
                                        <div class="progress-bar">
                                            <div class="progress-fill" style="width: 81.25%;"></div>
                                        </div>
                                        <div class="progress-labels">
                                            <span>Premium</span>
                                            <span>VIP</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="loyalty-benefits">
                                    <h5>Ưu đãi hiện tại:</h5>
                                    <ul>
                                        <li>✓ Giảm 10% phí giao dịch</li>
                                        <li>✓ Hoàn tiền 2% mỗi đặt phòng</li>
                                        <li>✓ Ưu tiên hỗ trợ 24/7</li>
                                        <li>✓ Nâng hạng phòng miễn phí</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Top Up Modal -->
    <div class="modal-overlay" id="topUpModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i class="fas fa-plus-circle"></i>
                    Nạp tiền vào ví
                </h2>
                <button class="modal-close" onclick="closeModal('topUpModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <!-- Progress Steps -->
                <div class="progress-steps">
                    <div class="progress-line" id="progressLine"></div>
                    <div class="progress-step">
                        <div class="step-circle active" id="step1">1</div>
                        <div class="step-label active">Chọn số tiền</div>
                    </div>
                    <div class="progress-step">
                        <div class="step-circle" id="step2">2</div>
                        <div class="step-label">Phương thức</div>
                    </div>
                    <div class="progress-step">
                        <div class="step-circle" id="step3">3</div>
                        <div class="step-label">Xác nhận</div>
                    </div>
                </div>

                <form id="topUpForm" onsubmit="processTopUp(event)">
                    <!-- Step 1: Amount Selection -->
                    <div class="form-section" id="amountSection">
                        <div class="form-section-title">
                            <i class="fas fa-money-bill-wave"></i>
                            Chọn số tiền nạp
                        </div>
                        
                        <div class="amount-selector">
                            <button type="button" class="amount-option" onclick="selectAmount(100000, this)">
                                100,000₫
                            </button>
                            <button type="button" class="amount-option" onclick="selectAmount(500000, this)">
                                500,000₫
                            </button>
                            <button type="button" class="amount-option" onclick="selectAmount(1000000, this)">
                                1,000,000₫
                            </button>
                            <button type="button" class="amount-option" onclick="selectAmount(2000000, this)">
                                2,000,000₫
                            </button>
                            <button type="button" class="amount-option" onclick="selectAmount(5000000, this)">
                                5,000,000₫
                            </button>
                            <button type="button" class="amount-option" onclick="selectAmount(10000000, this)">
                                10,000,000₫
                            </button>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Hoặc nhập số tiền khác</label>
                            <input type="number" class="form-input" id="customAmount" 
                                   placeholder="Nhập số tiền từ 10,000₫ đến 50,000,000₫" 
                                   min="10000" max="50000000" oninput="validateAmount(this)">
                            <div class="form-error" id="amountError" style="display: none;">
                                <i class="fas fa-exclamation-triangle"></i>
                                <span>Số tiền không hợp lệ</span>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Payment Method -->
                    <div class="form-section hidden" id="paymentSection">
                        <div class="form-section-title">
                            <i class="fas fa-credit-card"></i>
                            Chọn phương thức thanh toán
                        </div>
                        
                        <div class="payment-methods">
                            <div class="payment-method active" onclick="selectPaymentForTopUp(this, 'visa')">
                                <div class="payment-icon visa">VISA</div>
                                <div class="payment-details">
                                    <h4>Visa Platinum</h4>
                                    <p>**** **** **** 1234 • Hết hạn: 12/26</p>
                                </div>
                                <div class="payment-status">
                                    <div class="status-badge verified">Đã xác thực</div>
                                    <p class="text-xs">Phí: 0.5%</p>
                                </div>
                            </div>

                            <div class="payment-method" onclick="selectPaymentForTopUp(this, 'mastercard')">
                                <div class="payment-icon mastercard">MC</div>
                                <div class="payment-details">
                                    <h4>MasterCard Gold</h4>
                                    <p>**** **** **** 5678 • Hết hạn: 08/27</p>
                                </div>
                                <div class="payment-status">
                                    <div class="status-badge verified">Đã xác thực</div>
                                    <p class="text-xs">Phí: 0.5%</p>
                                </div>
                            </div>

                            <div class="payment-method" onclick="selectPaymentForTopUp(this, 'momo')">
                                <div class="payment-icon momo">MOMO</div>
                                <div class="payment-details">
                                    <h4>Ví MoMo</h4>
                                    <p>0987.654.321 • Số dư: 2,500,000₫</p>
                                </div>
                                <div class="payment-status">
                                    <div class="status-badge verified">Đã liên kết</div>
                                    <p class="text-xs">Phí: 0₫</p>
                                </div>
                            </div>

                            <div class="payment-method" onclick="selectPaymentForTopUp(this, 'bank')">
                                <div class="payment-icon bank">BANK</div>
                                <div class="payment-details">
                                    <h4>Vietcombank</h4>
                                    <p>**** **** **** 9876 • Tài khoản chính</p>
                                </div>
                                <div class="payment-status">
                                    <div class="status-badge verified">Đã xác thực</div>
                                    <p class="text-xs">Phí: 1,000₫</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 3: Confirmation -->
                    <div class="form-section hidden" id="confirmationSection">
                        <div class="form-section-title">
                            <i class="fas fa-check-circle"></i>
                            Xác nhận giao dịch
                        </div>
                        
                        <div class="transaction-summary">
                            <div class="summary-item">
                                <span>Số tiền nạp:</span>
                                <span id="summaryAmount" class="font-bold">0₫</span>
                            </div>
                            <div class="summary-item">
                                <span>Phương thức:</span>
                                <span id="summaryMethod" class="font-bold">-</span>
                            </div>
                            <div class="summary-item">
                                <span>Phí giao dịch:</span>
                                <span id="summaryFee" class="font-bold">0₫</span>
                            </div>
                            <div class="summary-item total">
                                <span>Tổng thanh toán:</span>
                                <span id="summaryTotal" class="font-bold">0₫</span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Mã OTP (nếu có)</label>
                            <input type="text" class="form-input" id="otpCode" 
                                   placeholder="Nhập mã OTP từ SMS hoặc app">
                        </div>
                    </div>

                    <!-- Navigation Buttons -->
                    <div class="form-navigation">
                        <button type="button" class="submit-button" id="prevBtn" onclick="previousStep()" style="display: none; background: var(--gray-400);">
                            <i class="fas fa-arrow-left"></i>
                            Quay lại
                        </button>
                        <button type="button" class="submit-button" id="nextBtn" onclick="nextStep()">
                            Tiếp tục
                            <i class="fas fa-arrow-right"></i>
                        </button>
                        <button type="submit" class="submit-button hidden" id="submitBtn">
                            <i class="fas fa-check"></i>
                            Xác nhận nạp tiền
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Transaction Details Modal -->
    <div class="modal-overlay" id="transactionModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i class="fas fa-receipt"></i>
                    Chi tiết giao dịch
                </h2>
                <button class="modal-close" onclick="closeModal('transactionModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content" id="transactionDetails">
                <!-- Transaction details will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Refund Processing Modal -->
    <div class="modal-overlay" id="refundModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i class="fas fa-undo"></i>
                    Xử lý hoàn tiền
                </h2>
                <button class="modal-close" onclick="closeModal('refundModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="refund-options">
                    <h3>Chọn cách nhận hoàn tiền</h3>
                    <p class="refund-subtitle">Số tiền hoàn: <span id="refundAmount" class="refund-amount">0₫</span></p>
                    
                    <div class="refund-option" onclick="selectRefundOption('wallet')">
                        <div class="option-icon">
                            <i class="fas fa-wallet"></i>
                        </div>
                        <div class="option-content">
                            <h4>Chuyển vào ví</h4>
                            <p>Nhận tiền ngay lập tức vào ví của bạn</p>
                            <div class="option-benefits">
                                <span class="benefit">✓ Miễn phí</span>
                                <span class="benefit">✓ Ngay lập tức</span>
                                <span class="benefit">✓ Có thể sử dụng ngay</span>
                            </div>
                        </div>
                        <div class="option-radio">
                            <input type="radio" name="refundOption" value="wallet" checked>
                        </div>
                    </div>
                    
                    <div class="refund-option" onclick="selectRefundOption('bank')">
                        <div class="option-icon">
                            <i class="fas fa-university"></i>
                        </div>
                        <div class="option-content">
                            <h4>Chuyển về ngân hàng</h4>
                            <p>Chuyển tiền về tài khoản ngân hàng của bạn</p>
                            <div class="option-benefits">
                                <span class="benefit">✓ Miễn phí</span>
                                <span class="benefit">✓ 1-3 ngày làm việc</span>
                                <span class="benefit">✓ An toàn</span>
                            </div>
                        </div>
                        <div class="option-radio">
                            <input type="radio" name="refundOption" value="bank">
                        </div>
                    </div>
                </div>
                
                <!-- Bank account form (hidden by default) -->
                <div id="bankAccountForm" class="form-section hidden">
                    <h4>Thông tin tài khoản ngân hàng</h4>
                    <div class="form-group">
                        <label class="form-label">Tên chủ tài khoản</label>
                        <input type="text" class="form-input" id="accountName" placeholder="Nhập tên chủ tài khoản">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Số tài khoản</label>
                        <input type="text" class="form-input" id="bankAccount" placeholder="Nhập số tài khoản ngân hàng">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ngân hàng</label>
                        <select class="form-input" id="bankName">
                            <option value="">Chọn ngân hàng</option>
                            <option value="Vietcombank">Vietcombank</option>
                            <option value="BIDV">BIDV</option>
                            <option value="Agribank">Agribank</option>
                            <option value="Techcombank">Techcombank</option>
                            <option value="MB Bank">MB Bank</option>
                            <option value="ACB">ACB</option>
                            <option value="VPBank">VPBank</option>
                            <option value="TPBank">TPBank</option>
                        </select>
                    </div>
                </div>
                
                <div class="modal-actions">
                    <button class="action-button secondary" onclick="closeModal('refundModal')">
                        <i class="fas fa-times"></i>
                        Hủy
                    </button>
                    <button class="action-button primary" onclick="processRefund()">
                        <i class="fas fa-check"></i>
                        Xác nhận hoàn tiền
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentBalance = 2450000;
        let selectedAmount = 0;
        let selectedPaymentMethod = 'visa';
        let currentStep = 1;
        let spendingChart;

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                document.getElementById('loadingScreen').classList.add('hidden');
                initializeApp();
            }, 2000);
        });

        function initializeApp() {
            animateBalance();
            initializeChart();
            addEventListeners();
            loadUserPreferences();
        }

        // Balance animation
        function animateBalance() {
            const balanceElements = [
                document.getElementById('balanceValue'),
                document.getElementById('mainBalance')
            ];
            
            let current = 0;
            const target = currentBalance;
            const increment = target / 80;
            
            const animation = setInterval(() => {
                current += increment;
                if (current >= target) {
                    current = target;
                    clearInterval(animation);
                }
                const formattedBalance = Math.floor(current).toLocaleString('vi-VN') + '₫';
                balanceElements.forEach(el => {
                    if (el) el.textContent = formattedBalance;
                });
            }, 20);
        }

        // Initialize spending chart
        function initializeChart() {
            const ctx = document.getElementById('spendingChart');
            if (!ctx) return;

            spendingChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Tháng 1', 'Tháng 2', 'Tháng 3', 'Tháng 4', 'Tháng 5', 'Tháng 6'],
                    datasets: [{
                        label: 'Chi tiêu khách sạn',
                        data: [3200000, 2800000, 4100000, 3600000, 4500000, 4750000],
                        borderColor: 'rgb(99, 102, 241)',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'Nạp tiền',
                        data: [5000000, 3000000, 6000000, 4000000, 5500000, 7000000],
                        borderColor: 'rgb(16, 185, 129)',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return (value / 1000000).toFixed(1) + 'M₫';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Event listeners
        function addEventListeners() {
            // Navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const page = this.getAttribute('data-page');
                    navigateToPage(page, this);
                });
            });

            // Search functionality
            const searchInput = document.querySelector('.search-input');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    searchTransactions(this.value);
                });
            }

            // Close modals on outside click
            document.querySelectorAll('.modal-overlay').forEach(overlay => {
                overlay.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeModal(this.id);
                    }
                });
            });

            // Keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeAllModals();
                }
            });
        }

        // Navigation
        function navigateToPage(page, navItem) {
            // Update active nav item
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            navItem.classList.add('active');

            // Update page title
            const pageTitles = {
                'wallet': 'Quản lý Ví',
                'transactions': 'Lịch sử Giao dịch',
                'cards': 'Thẻ & Tài khoản'
            };

            document.getElementById('pageTitle').textContent = pageTitles[page] || 'HotelPay Pro';
            
            // Show appropriate content (simplified for demo)
            showToast('Điều hướng', `Đang chuyển đến ${pageTitles[page]}`, 'success');
        }

        // Modal functions
        function openTopUpModal() {
            document.getElementById('topUpModal').classList.add('active');
            document.body.style.overflow = 'hidden';
            resetTopUpForm();
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            document.body.style.overflow = 'auto';
            if (modalId === 'topUpModal') {
                resetTopUpForm();
            }
        }

        function closeAllModals() {
            document.querySelectorAll('.modal-overlay.active').forEach(modal => {
                modal.classList.remove('active');
            });
            document.body.style.overflow = 'auto';
        }

        // Top-up form functions
        function resetTopUpForm() {
            currentStep = 1;
            selectedAmount = 0;
            selectedPaymentMethod = 'visa';
            
            // Reset form
            document.getElementById('topUpForm').reset();
            document.querySelectorAll('.amount-option').forEach(btn => btn.classList.remove('active'));
            
            // Reset steps
            updateStepProgress();
            showStep(1);
        }

        function selectAmount(amount, button) {
            selectedAmount = amount;
            document.querySelectorAll('.amount-option').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            document.getElementById('customAmount').value = amount;
            validateAmount(document.getElementById('customAmount'));
        }

        function validateAmount(input) {
            const amount = parseInt(input.value) || 0;
            const errorElement = document.getElementById('amountError');
            
            if (amount < 10000 || amount > 50000000) {
                input.classList.add('error');
                errorElement.style.display = 'flex';
                errorElement.querySelector('span').textContent = 
                    amount < 10000 ? 'Số tiền tối thiểu là 10,000₫' : 'Số tiền tối đa là 50,000,000₫';
                return false;
            } else {
                input.classList.remove('error');
                errorElement.style.display = 'none';
                selectedAmount = amount;
                
                // Remove active class from preset buttons if custom amount
                if (!document.querySelector('.amount-option.active') || 
                    parseInt(document.querySelector('.amount-option.active').textContent.replace(/[^\d]/g, '')) !== amount) {
                    document.querySelectorAll('.amount-option').forEach(btn => btn.classList.remove('active'));
                }
                return true;
            }
        }

        function selectPaymentForTopUp(element, method) {
            document.querySelectorAll('#paymentSection .payment-method').forEach(pm => {
                pm.classList.remove('active');
            });
            element.classList.add('active');
            selectedPaymentMethod = method;
        }

        function nextStep() {
            if (currentStep === 1) {
                // Validate amount
                const amountInput = document.getElementById('customAmount');
                if (!selectedAmount || !validateAmount(amountInput)) {
                    showToast('Lỗi', 'Vui lòng chọn hoặc nhập số tiền hợp lệ', 'error');
                    return;
                }
                currentStep = 2;
            } else if (currentStep === 2) {
                currentStep = 3;
                updateTransactionSummary();
            }
            
            updateStepProgress();
            showStep(currentStep);
        }

        function previousStep() {
            if (currentStep > 1) {
                currentStep--;
                updateStepProgress();
                showStep(currentStep);
            }
        }

        function updateStepProgress() {
            // Update step circles
            for (let i = 1; i <= 3; i++) {
                const circle = document.getElementById(`step${i}`);
                const label = circle.nextElementSibling;
                
                if (i < currentStep) {
                    circle.classList.add('completed');
                    circle.classList.remove('active');
                    circle.innerHTML = '<i class="fas fa-check"></i>';
                    label.classList.remove('active');
                } else if (i === currentStep) {
                    circle.classList.add('active');
                    circle.classList.remove('completed');
                    circle.textContent = i;
                    label.classList.add('active');
                } else {
                    circle.classList.remove('active', 'completed');
                    circle.textContent = i;
                    label.classList.remove('active');
                }
            }
            
            // Update progress line
            const progressLine = document.getElementById('progressLine');
            const width = ((currentStep - 1) / 2) * 100;
            progressLine.style.width = `calc(${width}% - 20px)`;
        }

        function showStep(step) {
            // Hide all sections
            document.querySelectorAll('.form-section').forEach(section => {
                section.classList.add('hidden');
            });
            
            // Show current section
            const sections = ['amountSection', 'paymentSection', 'confirmationSection'];
            document.getElementById(sections[step - 1]).classList.remove('hidden');
            
            // Update buttons
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const submitBtn = document.getElementById('submitBtn');
            
            prevBtn.style.display = step > 1 ? 'flex' : 'none';
            nextBtn.style.display = step < 3 ? 'flex' : 'none';
            submitBtn.classList.toggle('hidden', step < 3);
        }

        function updateTransactionSummary() {
            const fees = {
                'visa': Math.ceil(selectedAmount * 0.005),
                'mastercard': Math.ceil(selectedAmount * 0.005),
                'momo': 0,
                'bank': 1000
            };
            
            const fee = fees[selectedPaymentMethod] || 0;
            const total = selectedAmount + fee;
            
            const methodNames = {
                'visa': 'Visa Platinum (**** 1234)',
                'mastercard': 'MasterCard Gold (**** 5678)',
                'momo': 'Ví MoMo (0987.654.321)',
                'bank': 'Vietcombank (**** 9876)'
            };
            
            document.getElementById('summaryAmount').textContent = selectedAmount.toLocaleString('vi-VN') + '₫';
            document.getElementById('summaryMethod').textContent = methodNames[selectedPaymentMethod];
            document.getElementById('summaryFee').textContent = fee.toLocaleString('vi-VN') + '₫';
            document.getElementById('summaryTotal').textContent = total.toLocaleString('vi-VN') + '₫';
        }

        function processTopUp(event) {
            event.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.classList.add('loading');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span>Đang xử lý...</span>';
            
            // Add CSRF token
            const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
            
            const formData = new FormData();
            formData.append('amount', selectedAmount);
            formData.append('paymentMethod', selectedPaymentMethod);
            formData.append('_csrf', csrfToken);
            
            fetch('/wallet/topup', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update balance
                    currentBalance = data.newBalance;
                    animateBalance();
                    
                    // Show success
                    showToast('Nạp tiền thành công!', 
                        `Đã nạp ${selectedAmount.toLocaleString('vi-VN')}₫ vào ví của bạn`, 'success');
                    
                    // Close modal
                    closeModal('topUpModal');
                    
                    // Reload page to update transaction list
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    showToast('Lỗi', data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Lỗi', 'Có lỗi xảy ra khi nạp tiền', 'error');
            })
            .finally(() => {
                // Reset button
                submitBtn.classList.remove('loading');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-check"></i> Xác nhận nạp tiền';
            });
        }

        function addNewTransaction() {
            const container = document.getElementById('transactionsContainer');
            const newTransaction = document.createElement('div');
            newTransaction.className = 'transaction-item';
            newTransaction.setAttribute('data-type', 'topup');
            
            const now = new Date();
            const timeString = `${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;
            const transactionId = 'TXN' + Date.now().toString().slice(-6);
            
            const methodNames = {
                'visa': 'Visa Platinum',
                'mastercard': 'MasterCard Gold',
                'momo': 'MoMo',
                'bank': 'Vietcombank'
            };
            
            newTransaction.innerHTML = `
                <div class="transaction-icon topup">
                    <i class="fas fa-plus"></i>
                    <div class="transaction-status success"></div>
                </div>
                <div class="transaction-details">
                    <div class="transaction-title">Nạp tiền từ ${methodNames[selectedPaymentMethod]}</div>
                    <div class="transaction-meta">Vừa xong, ${timeString} • Thành công</div>
                    <div class="transaction-id">ID: ${transactionId}</div>
                </div>
                <div class="transaction-amount">
                    <div class="amount-value positive">+${selectedAmount.toLocaleString('vi-VN')}₫</div>
                    <div class="amount-fee">Phí: 0₫</div>
                </div>
            `;
            
            newTransaction.onclick = () => showTransactionDetails(transactionId);
            
            // Add with animation
            newTransaction.style.opacity = '0';
            newTransaction.style.transform = 'translateY(-20px)';
            container.insertBefore(newTransaction, container.firstChild);
            
            setTimeout(() => {
                newTransaction.style.transition = 'all 0.5s ease';
                newTransaction.style.opacity = '1';
                newTransaction.style.transform = 'translateY(0)';
            }, 100);
        }

        // Transaction filtering
        function filterTransactions(type, button) {
            // Update active filter
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            
            // Filter transactions
            const transactions = document.querySelectorAll('.transaction-item');
            transactions.forEach((transaction, index) => {
                const transactionType = transaction.getAttribute('data-type');
                const shouldShow = type === 'all' || transactionType === type;
                
                if (shouldShow) {
                    setTimeout(() => {
                        transaction.style.display = 'flex';
                        transaction.style.opacity = '0';
                        transaction.style.transform = 'translateX(-20px)';
                        
                        setTimeout(() => {
                            transaction.style.transition = 'all 0.3s ease';
                            transaction.style.opacity = '1';
                            transaction.style.transform = 'translateX(0)';
                        }, 50);
                    }, index * 50);
                } else {
                    transaction.style.opacity = '0';
                    transaction.style.transform = 'translateX(-20px)';
                    setTimeout(() => {
                        transaction.style.display = 'none';
                    }, 300);
                }
            });
        }

        // Search transactions
        function searchTransactions(query) {
            const transactions = document.querySelectorAll('.transaction-item');
            const searchTerm = query.toLowerCase();
            
            transactions.forEach(transaction => {
                const title = transaction.querySelector('.transaction-title').textContent.toLowerCase();
                const meta = transaction.querySelector('.transaction-meta').textContent.toLowerCase();
                const id = transaction.querySelector('.transaction-id').textContent.toLowerCase();
                
                const matches = title.includes(searchTerm) || meta.includes(searchTerm) || id.includes(searchTerm);
                
                if (matches || !query) {
                    transaction.style.display = 'flex';
                    transaction.style.opacity = '1';
                } else {
                    transaction.style.opacity = '0.3';
                }
            });
        }

        // Transaction details
        function showTransactionDetails(transactionId) {
            const modal = document.getElementById('transactionModal');
            const content = document.getElementById('transactionDetails');
            
            // Mock transaction data
            const transactionData = {
                'TXN001': {
                    id: 'TXN001',
                    type: 'hotel',
                    title: 'Khách sạn Lotte Center Hanoi',
                    amount: -1200000,
                    fee: 0,
                    status: 'success',
                    date: '2025-07-24 14:30:00',
                    method: 'Ví HotelPay',
                    description: 'Thanh toán đặt phòng Deluxe Room, 2 đêm',
                    hotel: {
                        name: 'Lotte Center Hanoi',
                        address: '54 Liễu Giai, Ba Đình, Hà Nội',
                        checkin: '2025-07-25',
                        checkout: '2025-07-27',
                        room: 'Deluxe Room',
                        guests: 2
                    }
                }
                // Add more mock data as needed
            };
            
            const transaction = transactionData[transactionId] || {
                id: transactionId,
                title: 'Giao dịch không tìm thấy',
                amount: 0,
                status: 'unknown'
            };
            
            content.innerHTML = `
                <div class="transaction-detail-card">
                    <div class="detail-header">
                        <div class="detail-icon ${transaction.type || 'unknown'}">
                            <i class="fas fa-${transaction.type === 'hotel' ? 'bed' : transaction.type === 'topup' ? 'plus' : 'question'}"></i>
                        </div>
                        <div class="detail-info">
                            <h3>${transaction.title}</h3>
                            <p>Mã giao dịch: ${transaction.id}</p>
                        </div>
                        <div class="detail-amount ${transaction.amount > 0 ? 'positive' : 'negative'}">
                            ${transaction.amount > 0 ? '+' : ''}${Math.abs(transaction.amount).toLocaleString('vi-VN')}₫
                        </div>
                    </div>
                    
                    <div class="detail-sections">
                        <div class="detail-section">
                            <h4><i class="fas fa-info-circle"></i> Thông tin giao dịch</h4>
                            <div class="detail-grid">
                                <div class="detail-item">
                                    <span>Trạng thái:</span>
                                    <span class="status-badge ${transaction.status}">
                                        ${transaction.status === 'success' ? 'Thành công' : 'Không xác định'}
                                    </span>
                                </div>
                                <div class="detail-item">
                                    <span>Thời gian:</span>
                                    <span>${new Date(transaction.date || Date.now()).toLocaleString('vi-VN')}</span>
                                </div>
                                <div class="detail-item">
                                    <span>Phương thức:</span>
                                    <span>${transaction.method || 'Ví HotelPay'}</span>
                                </div>
                                <div class="detail-item">
                                    <span>Phí giao dịch:</span>
                                    <span>${(transaction.fee || 0).toLocaleString('vi-VN')}₫</span>
                                </div>
                            </div>
                        </div>
                        
                        ${transaction.hotel ? `
                        <div class="detail-section">
                            <h4><i class="fas fa-bed"></i> Thông tin đặt phòng</h4>
                            <div class="detail-grid">
                                <div class="detail-item">
                                    <span>Khách sạn:</span>
                                    <span>${transaction.hotel.name}</span>
                                </div>
                                <div class="detail-item">
                                    <span>Địa chỉ:</span>
                                    <span>${transaction.hotel.address}</span>
                                </div>
                                <div class="detail-item">
                                    <span>Nhận phòng:</span>
                                    <span>${new Date(transaction.hotel.checkin).toLocaleDateString('vi-VN')}</span>
                                </div>
                                <div class="detail-item">
                                    <span>Trả phòng:</span>
                                    <span>${new Date(transaction.hotel.checkout).toLocaleDateString('vi-VN')}</span>
                                </div>
                                <div class="detail-item">
                                    <span>Loại phòng:</span>
                                    <span>${transaction.hotel.room}</span>
                                </div>
                                <div class="detail-item">
                                    <span>Số khách:</span>
                                    <span>${transaction.hotel.guests} người</span>
                                </div>
                            </div>
                        </div>
                        ` : ''}
                        
                        <div class="detail-actions">
                            <button class="action-button" onclick="downloadReceipt('${transaction.id}')">
                                <i class="fas fa-download"></i>
                                Tải hóa đơn
                            </button>
                            <button class="action-button" onclick="shareTransaction('${transaction.id}')" style="background: var(--success);">
                                <i class="fas fa-share"></i>
                                Chia sẻ
                            </button>
                            ${transaction.type === 'hotel' ? `
                            <button class="action-button" onclick="contactSupport('${transaction.id}')" style="background: var(--warning);">
                                <i class="fas fa-headset"></i>
                                Hỗ trợ
                            </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        // Toast notifications
        function showToast(title, message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: 'fas fa-check',
                error: 'fas fa-times',
                warning: 'fas fa-exclamation-triangle',
                info: 'fas fa-info'
            };
            
            toast.innerHTML = `
                <div class="toast-icon">
                    <i class="${icons[type] || icons.info}"></i>
                </div>
                <div class="toast-content">
                    <h4>${title}</h4>
                    <p>${message}</p>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            container.appendChild(toast);
            
            // Show toast
            setTimeout(() => toast.classList.add('show'), 100);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }

        // Utility functions
        function selectPaymentMethod(element) {
            document.querySelectorAll('.payment-method').forEach(pm => pm.classList.remove('active'));
            element.classList.add('active');
        }

        function loadUserPreferences() {
            // Load user preferences from localStorage or API
            const preferences = JSON.parse(localStorage.getItem('hotelPayPreferences') || '{}');
            
            // Apply preferences
            if (preferences.theme) {
                document.body.classList.add(`theme-${preferences.theme}`);
            }
        }

        function saveUserPreferences() {
            const preferences = {
                theme: 'default',
                language: 'vi',
                notifications: true
            };
            
            localStorage.setItem('hotelPayPreferences', JSON.stringify(preferences));
        }

        // Additional feature functions
        function openWithdrawModal() {
            showToast('Thông báo', 'Chức năng rút tiền sẽ được cập nhật sớm!', 'info');
        }

        function openTransferModal() {
            showToast('Thông báo', 'Chức năng chuyển khoản sẽ được cập nhật sớm!', 'info');
        }

        function openBookingModal() {
            showToast('Đặt phòng', 'Chuyển đến trang đặt phòng khách sạn...', 'success');
        }

        function showHistory() {
            navigateToPage('transactions', document.querySelector('[data-page="transactions"]'));
        }

        function showRewards() {
            showToast('Ưu đãi', 'Hiển thị các chương trình khuyến mãi hiện có', 'success');
        }

        function showNotifications() {
            showToast('Thông báo', 'Bạn có 5 thông báo mới!', 'info');
        }

        function showBalanceDetails() {
            showToast('Chi tiết số dư', `Số dư hiện tại: ${currentBalance.toLocaleString('vi-VN')}₫`, 'success');
        }

        function showSpendingDetails() {
            showToast('Chi tiêu', 'Hiển thị báo cáo chi tiêu chi tiết', 'info');
        }

        function showBookingStats() {
            showToast('Thống kê', 'Hiển thị thống kê đặt phòng của bạn', 'info');
        }

        function showRewardsDetails() {
            showToast('Điểm thưởng', 'Hiển thị chi tiết chương trình tích điểm', 'success');
        }

        function showUserProfile() {
            navigateToPage('profile', document.querySelector('[data-page="profile"]'));
        }

        function showBalanceMenu() {
            showToast('Menu', 'Hiển thị các tùy chọn quản lý số dư', 'info');
        }

        function addPaymentMethod() {
            showToast('Thêm thẻ', 'Mở form thêm phương thức thanh toán mới', 'info');
        }

        function showAllTransactions() {
            navigateToPage('transactions', document.querySelector('[data-page="transactions"]'));
        }

        function showAllBookings() {
            navigateToPage('bookings', document.querySelector('[data-page="bookings"]'));
        }

        function exportTransactions() {
            showToast('Xuất dữ liệu', 'Đang chuẩn bị file Excel...', 'success');
        }

        function changeChartPeriod(period) {
            showToast('Biểu đồ', `Cập nhật biểu đồ cho kỳ ${period}`, 'info');
        }

        function showBookingDetails(bookingId) {
            showToast('Chi tiết đặt phòng', `Hiển thị thông tin đặt phòng ${bookingId}`, 'info');
        }

        function downloadReceipt(transactionId) {
            showToast('Tải hóa đơn', `Đang tải hóa đơn cho giao dịch ${transactionId}`, 'success');
        }

        function shareTransaction(transactionId) {
            showToast('Chia sẻ', `Chia sẻ thông tin giao dịch ${transactionId}`, 'success');
        }

        function contactSupport(transactionId) {
            showToast('Hỗ trợ', `Liên hệ hỗ trợ cho giao dịch ${transactionId}`, 'info');
        }

        // Refund processing functions
        let currentRefundBookingId = null;
        let currentRefundAmount = 0;

        function showPendingRefund(bookingId) {
            // Fetch booking details and show refund modal
            fetch(`/api/booking/${bookingId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        currentRefundBookingId = bookingId;
                        currentRefundAmount = data.booking.refundAmount;
                        
                        document.getElementById('refundAmount').textContent = 
                            currentRefundAmount.toLocaleString('vi-VN') + '₫';
                        
                        openModal('refundModal');
                    } else {
                        showToast('Lỗi', 'Không thể tải thông tin đặt phòng', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('Lỗi', 'Có lỗi xảy ra khi tải thông tin', 'error');
                });
        }

        function showRefundDetails(bookingId) {
            // Show detailed refund information
            showTransactionDetails('REFUND_' + bookingId);
        }

        function selectRefundOption(option) {
            // Update radio buttons
            document.querySelectorAll('input[name="refundOption"]').forEach(radio => {
                radio.checked = radio.value === option;
            });
            
            // Update option styling
            document.querySelectorAll('.refund-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            // Show/hide bank account form
            const bankForm = document.getElementById('bankAccountForm');
            if (option === 'bank') {
                bankForm.classList.remove('hidden');
            } else {
                bankForm.classList.add('hidden');
            }
        }

        function processRefund() {
            const selectedOption = document.querySelector('input[name="refundOption"]:checked').value;
            const processBtn = document.querySelector('#refundModal .action-button.primary');
            
            // Validate form if bank option is selected
            if (selectedOption === 'bank') {
                const accountName = document.getElementById('accountName').value.trim();
                const bankAccount = document.getElementById('bankAccount').value.trim();
                const bankName = document.getElementById('bankName').value;
                
                if (!accountName || !bankAccount || !bankName) {
                    showToast('Lỗi', 'Vui lòng điền đầy đủ thông tin tài khoản ngân hàng', 'error');
                    return;
                }
            }
            
            // Disable button and show loading
            processBtn.disabled = true;
            processBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang xử lý...';
            
            const endpoint = selectedOption === 'wallet' ? '/wallet/process-refund' : '/wallet/withdraw-refund';
            const formData = new FormData();
            formData.append('bookingId', currentRefundBookingId);
            
            if (selectedOption === 'bank') {
                formData.append('bankAccount', document.getElementById('bankAccount').value);
                formData.append('accountName', document.getElementById('accountName').value);
            }
            
            // Add CSRF token
            const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
            formData.append('_csrf', csrfToken);
            
            fetch(endpoint, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('Hoàn tiền thành công!', data.message, 'success');
                    closeModal('refundModal');
                    
                    // Update balance if refunded to wallet
                    if (selectedOption === 'wallet' && data.newBalance) {
                        currentBalance = data.newBalance;
                        animateBalance();
                    }
                    
                    // Reload page to update transaction list
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    showToast('Lỗi', data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Lỗi', 'Có lỗi xảy ra khi xử lý hoàn tiền', 'error');
            })
            .finally(() => {
                // Re-enable button
                processBtn.disabled = false;
                processBtn.innerHTML = '<i class="fas fa-check"></i> Xác nhận hoàn tiền';
            });
        }

        // Update transaction filtering to include refund-pending
        function filterTransactions(type, button) {
            // Update active filter
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            
            // Filter transactions
            const transactions = document.querySelectorAll('.transaction-item');
            transactions.forEach((transaction, index) => {
                const transactionType = transaction.getAttribute('data-type');
                let shouldShow = false;
                
                if (type === 'all') {
                    shouldShow = true;
                } else if (type === 'refund') {
                    shouldShow = transactionType === 'refund' || transactionType === 'refund-pending';
                } else {
                    shouldShow = transactionType === type;
                }
                
                if (shouldShow) {
                    setTimeout(() => {
                        transaction.style.display = 'flex';
                        transaction.style.opacity = '0';
                        transaction.style.transform = 'translateX(-20px)';
                        
                        setTimeout(() => {
                            transaction.style.transition = 'all 0.3s ease';
                            transaction.style.opacity = '1';
                            transaction.style.transform = 'translateX(0)';
                        }, 50);
                    }, index * 50);
                } else {
                    transaction.style.opacity = '0';
                    transaction.style.transform = 'translateX(-20px)';
                    setTimeout(() => {
                        transaction.style.display = 'none';
                    }, 300);
                }
            });
        }

        // Auto-save form data
        setInterval(() => {
            saveUserPreferences();
        }, 30000); // Save every 30 seconds
    </script>
</body>
</html>