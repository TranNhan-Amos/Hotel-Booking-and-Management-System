<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Khách Hàng - Admin</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="Css/Management-Customers.css"  th:href="@{/Css/Management-Customers.css}">
    <style>
        
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="logo">Admin KS</div>
        <ul>
            <li><a href="/admin/rooms"><i class="fas fa-bed"></i> Quản Lý Phòng</a></li>
            <li><a href="/admin/bookings"><i class="fas fa-calendar-check"></i> Quản Lý Đặt Phòng</a></li>
            <li><a href="/admin/customers" class="active"><i class="fas fa-users"></i> Quản Lý Khách Hàng</a></li>
            <li><a href="/client/Evaluate"><i class="fas fa-star"></i> Bình Luận & Đánh Giá</a></li>
            <li><a href="/admin/vouchers"><i class="fas fa-ticket-alt"></i> Quản Lý Voucher</a></li>
            <li><a href="#"><i class="fas fa-chart-bar"></i> Báo Cáo</a></li>
            <li><a href="#"><i class="fas fa-cog"></i> Cài Đặt</a></li>
            <li><a href="#"><i class="fas fa-sign-out-alt"></i> Đăng Xuất</a></li>
        </ul>
    </div>
    <!-- Main Content -->
    <div class="main-content">
        <div class="hamburger" onclick="toggleSidebar()">
            <i class="fas fa-bars"></i>
        </div>
        <div class="management-section">
            <h2>Quản Lý Khách Hàng</h2>
            <div class="management-header">
                <div class="search-filter">
                    <input type="text" id="searchInput" placeholder="Tìm kiếm tên hoặc mã khách..." oninput="filterCustomers()">
                    <select id="statusFilter" onchange="filterCustomers()">
                        <option value="all">Tất Cả Trạng Thái</option>
                        <option value="regular">Khách Thường</option>
                        <option value="vip">Khách VIP</option>
                    </select>
                </div>
                <!-- <button class="add-customer-btn" onclick="openModal('add')">Thêm Khách Hàng</button> -->
            </div>
            <table class="customer-table">
                <thead>
                    <tr>
                        <th>Mã Khách</th>
                        <th>Tên Khách</th>
                        <th>Số Điện Thoại</th>
                        <th>Email</th>
                        <th>Số Lần Đặt Phòng</th>
                        <th>Ngày Đăng Ký</th>
                        <th>Trạng Thái</th>
                        <th>Hành Động</th>
                    </tr>
                </thead>
                <tbody id="customerTableBody">
                    <tr th:each="customer : ${customers}">
                        <td data-label="Mã Khách"  th:text="${customer.customerId}">KH001</td>
                        <td data-label="Tên Khách" th:text="${customer.name}">Nguyễn Văn A</td>
                        <td data-label="Số Điện Thoại" th:text="${customer.phone}">0901234567</td>
                        <td data-label="Email" th:text="${customer.email}">nguyenvana@example.com</td>
                        <td data-label="Số Lần Đặt Phòng">5</td>
                        <td data-label="Ngày Đăng Ký" th:text="${#dates.format(customer.createdDate, 'dd/MM/yyyy')}">15/05/2025</td>
                        <td data-label="Trạng Thái" ><span th:class="'status ' + (${customer.status} == 'regular' ? 'regular' : 'vip')" th:text="${customer.status == 'regular'} ? 'Khách Thường' : 'Khách VIP'">Khách VIP</span></td>
                        <td data-label="Hành Động" class="actions">
                            <button class="edit-btn" onclick="openModal('edit', this)">Sửa</button>
                            <button class="delete-btn" onclick="deleteCustomer(this)">Xóa</button>
                        </td>
                    </tr>
            
                </tbody>
            </table>
            <div class="chart-container">
                <h3>Thống Kê Số Lần Đặt Phòng</h3>
                <canvas id="bookingChart" width="400" height="200"></canvas>
            </div>
        </div>

        <!-- Modal for Add/Edit Customer -->
      <div class="modal" id="customerModal">
    <div class="modal-content">
        <h3 id="modalTitle">Sửa Khách Hàng</h3>
        <form id="customerForm" th:action="@{/admin/customers/update}" method="post">
            <input type="hidden" id="customerId" name="customerId">
            <div class="form-group">
                <label for="customerName">Tên Khách</label>
                <input type="text" id="customerName" name="name" placeholder="Nguyễn Văn A" required>
            </div>
            <div class="form-group">
                <label for="phoneNumber">Số Điện Thoại</label>
                <input type="text" id="phoneNumber" name="phone" placeholder="0901234567" required pattern="[0-9]{10}">
            </div>
            <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" name="email" placeholder="nguyenvana@example.com" required>
            </div>
            <div class="form-group">
                <label for="bookingCount">Số Lần Đặt Phòng</label>
                <input type="number" id="bookingCount" name="bookingCount" placeholder="5" min="0" required>
            </div>
            <div class="form-group">
                <label for="createdDate">Ngày Đăng Ký</label>
                <input type="date" id="createdDate" name="createdDate" required>
            </div>
            <div class="form-group">
                <label for="customerStatus">Trạng Thái</label>
                <select id="customerStatus" name="status" required>
                    <option value="regular">Khách Thường</option>
                    <option value="vip">Khách VIP</option>
                </select>
            </div>
            <div class="modal-actions">
                <button type="submit" class="save-btn">Lưu</button>
                <button type="button" class="cancel-btn" onclick="closeModal()">Hủy</button>
            </div>
        </form>
    </div>
</div>
    </div>

    <!-- JavaScript for Customer Management -->
    <script>
        let editRow = null;

        function openModal(mode, row) {
            const modal = document.getElementById('customerModal');
            const modalTitle = document.getElementById('modalTitle');
            const customerId = document.getElementById('customerId');
            const customerName = document.getElementById('customerName');
            const phoneNumber = document.getElementById('phoneNumber');
            const email = document.getElementById('email');
            const bookingCount = document.getElementById('bookingCount');
            const registerDate = document.getElementById('createdDate');
            const customerStatus = document.getElementById('customerStatus');

            if (mode === 'add') {
                modalTitle.textContent = 'Thêm Khách Hàng';
                customerId.value = '';
                customerName.value = '';
                phoneNumber.value = '';
                email.value = '';
                bookingCount.value = '';
                registerDate.value = '';
                customerStatus.value = 'regular';
                editRow = null;
            } else if (mode === 'edit') {
                modalTitle.textContent = 'Sửa Khách Hàng';
                editRow = row.parentElement.parentElement;
                customerId.value = editRow.cells[0].textContent;
                customerName.value = editRow.cells[1].textContent;
                phoneNumber.value = editRow.cells[2].textContent;
                email.value = editRow.cells[3].textContent;
                bookingCount.value = editRow.cells[4].textContent;
                const registerParts = editRow.cells[5].textContent.split('/');
                registerDate.value = `${registerParts[2]}-${registerParts[1].padStart(2, '0')}-${registerParts[0].padStart(2, '0')}`;
                customerStatus.value = editRow.cells[6].querySelector('.status').classList.contains('regular') ? 'regular' : 'vip';
            }

            modal.style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('customerModal').style.display = 'none';
            editRow = null;
        }

        function saveCustomer() {
            const customerId = document.getElementById('customerId').value;
            const customerName = document.getElementById('customerName').value;
            const phoneNumber = document.getElementById('phoneNumber').value;
            const email = document.getElementById('email').value;
            const bookingCount = document.getElementById('bookingCount').value;
            const registerDate = document.getElementById('registerDate').value;
            const customerStatus = document.getElementById('customerStatus').value;

            if (!customerId || !customerName || !phoneNumber || !email || !bookingCount || !registerDate) {
                alert('Vui lòng điền đầy đủ thông tin!');
                return;
            }

            const statusClass = customerStatus === 'regular' ? 'regular' : 'vip';
            const statusText = customerStatus === 'regular' ? 'Khách Thường' : 'Khách VIP';
            const registerFormatted = registerDate.split('-').reverse().join('/');

            if (editRow) {
                // Edit existing row
                editRow.cells[0].textContent = customerId;
                editRow.cells[1].textContent = customerName;
                editRow.cells[2].textContent = phoneNumber;
                editRow.cells[3].textContent = email;
                editRow.cells[4].textContent = bookingCount;
                editRow.cells[5].textContent = registerFormatted;
                editRow.cells[6].innerHTML = `<span class="status ${statusClass}">${statusText}</span>`;
            } else {
                // Add new row
                const tableBody = document.getElementById('customerTableBody');
                const newRow = document.createElement('tr');
                newRow.innerHTML = `
                    <td data-label="Mã Khách">${customerId}</td>
                    <td data-label="Tên Khách">${customerName}</td>
                    <td data-label="Số Điện Thoại">${phoneNumber}</td>
                    <td data-label="Email">${email}</td>
                    <td data-label="Số Lần Đặt Phòng">${bookingCount}</td>
                    <td data-label="Ngày Đăng Ký">${registerFormatted}</td>
                    <td data-label="Trạng Thái"><span class="status ${statusClass}">${statusText}</span></td>
                    <td data-label="Hành Động" class="actions">
                        <button class="edit-btn" onclick="openModal('edit', this)">Sửa</button>
                        <button class="delete-btn" onclick="deleteCustomer(this)">Xóa</button>
                    </td>
                `;
                tableBody.appendChild(newRow);
            }

            closeModal();
            filterCustomers();
            updateChart();
        }

        function deleteCustomer(button) {
            if (confirm('Bạn có chắc muốn xóa khách hàng này?')) {
                button.parentElement.parentElement.remove();
                updateChart();
            }
        }

        function filterCustomers() {
            const searchInput = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const rows = document.querySelectorAll('#customerTableBody tr');

            rows.forEach(row => {
                const customerName = row.cells[1].textContent.toLowerCase();
                const customerId = row.cells[0].textContent.toLowerCase();
                const status = row.cells[6].querySelector('.status').classList.contains('regular') ? 'regular' : 'vip';

                const matchesSearch = customerName.includes(searchInput) || customerId.includes(searchInput);
                const matchesStatus = statusFilter === 'all' || status === statusFilter;

                if (matchesSearch && matchesStatus) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('active');
        }

        // Chart Functions
        function updateChart() {
            const ctx = document.getElementById('bookingChart').getContext('2d');
            const rows = document.querySelectorAll('#customerTableBody tr');
            const labels = [];
            const data = [];

            rows.forEach(row => {
                labels.push(row.cells[1].textContent); // Tên khách
                data.push(parseInt(row.cells[4].textContent)); // Số lần đặt phòng
            });

            if (window.myChart) window.myChart.destroy();

            window.myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Số Lần Đặt Phòng',
                        data: data,
                        backgroundColor: '#6c5ce7',
                        borderColor: '#5b4cd5',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Số Lần' }
                        },
                        x: {
                            title: { display: true, text: 'Tên Khách Hàng' }
                        }
                    }
                }
            });
        }

        // Initialize chart
        window.onload = updateChart;
    </script>
</body>
</html>