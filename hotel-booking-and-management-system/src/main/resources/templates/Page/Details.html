<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${room.type + ' - Chi Tiết Phòng'}">Chi Tiết Phòng</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" th:content="${room.description}">
    <meta property="og:title" th:content="${room.type}">
    <meta property="og:description" th:content="${room.description}">
    <meta property="og:image" th:content="${room.imageUrls != null and !room.imageUrls.empty ? room.imageUrls[0] : ''}">
    <meta property="og:type" content="website">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/Css/Narbar.css}">
    <link rel="stylesheet" th:href="@{/Css/Details.css}">
    
    <style>
        .hotel-header {
            background: var(--gradient-card);
            border-radius: var(--border-radius-xl);
            box-shadow: var(--shadow-purple);
            padding: 2.5rem 2rem 1.5rem 2rem;
            margin-bottom: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1.2rem;
            align-items: flex-start;
        }
        .hotel-header h1 {
            font-size: 2.2rem;
            font-weight: 700;
            margin: 0;
            color: var(--primary-purple-dark);
            letter-spacing: 0.5px;
        }
        .room-status {
            display: inline-block;
            padding: 0.25em 1em;
            border-radius: 999px;
            font-size: 1rem;
            font-weight: 500;
            margin-left: 0.5rem;
            margin-bottom: 0.5rem;
            background: var(--gray-100);
            color: var(--primary-purple-dark);
            box-shadow: var(--shadow-sm);
        }
        .room-status.available {
            background: linear-gradient(90deg, #dcfce7 0%, #bbf7d0 100%);
            color: var(--success-color);
        }
        .room-status.booked {
            background: linear-gradient(90deg, #fee2e2 0%, #fecaca 100%);
            color: var(--danger-color);
        }
        .room-status.unknown {
            background: var(--gray-200);
            color: var(--gray-500);
        }
        .hotel-header .info {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            font-size: 1.1rem;
            color: var(--primary-purple);
            font-weight: 400;
        }
        .hotel-header .rating {
            background: var(--accent-orange-light);
            color: var(--accent-orange-dark);
            border-radius: 0.75rem;
            padding: 0.3em 1em;
            font-size: 1.1rem;
            font-weight: 600;
            box-shadow: var(--shadow-orange);
        }
        .hotel-header .location {
            color: var(--gray-500);
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 0.3em;
        }
        .room-actions {
            display: flex;
            gap: 0.7rem;
            margin-top: 0.5rem;
        }
        .action-btn {
            background: var(--primary-purple-light);
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: box-shadow 0.2s, background 0.2s;
            box-shadow: var(--shadow-sm);
            color: var(--white);
            font-size: 1.2rem;
            position: relative;
        }
        .action-btn span {
            display: none;
        }
        .action-btn:hover {
            background: var(--primary-purple-dark);
            color: var(--accent-orange);
            box-shadow: var(--shadow-purple);
        }
        @media (max-width: 600px) {
            .hotel-header {
                padding: 1.2rem 0.7rem 1rem 0.7rem;
            }
            .hotel-header h1 {
                font-size: 1.3rem;
            }
            .room-status {
                font-size: 0.9rem;
            }
        }
    </style>
   

    <style>
        .room-status {
            display: inline-block;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin-left: 12px;
            color: #fff;
        }
        .room-status.available { background: #22c55e; }
        .room-status.booked { background: #ef4444; }
        .room-status.unknown { background: #64748b; }
        .hotel-header h1 { display: inline; }
    </style>
</head>
<body>
    <div th:replace="~{/Layout/narbar}"></div>

    <div th:replace="~{/Layout/narbar}"></div>

    <div class="container">

        <!-- Error Messages -->
        <div th:if="${error}" class="alert alert-danger">
        <div th:if="${error}" class="alert alert-danger" style="background: #f8d7da; color: #721c24; padding: 12px; border-radius: 4px; margin-bottom: 20px; border: 1px solid #f5c6cb;">
            <i class="fas fa-exclamation-circle"></i>
            <span th:text="${error}">Lỗi</span>
        </div>

        <!-- Success Messages -->
        <div th:if="${message}" class="alert alert-success">
        <div th:if="${message}" class="alert alert-success" style="background: #d4edda; color: #155724; padding: 12px; border-radius: 4px; margin-bottom: 20px; border: 1px solid #c3e6cb;">
            <i class="fas fa-check-circle"></i>
            <span th:text="${message}">Thành công</span>
        </div>

        <!-- Breadcrumb Navigation -->
        <div class="breadcrumb">
            <a href="/">Trang chủ</a> > 
            <a href="/ListRoom">Danh sách phòng</a> > 
            <span th:text="${room.type}">Tên phòng</span>
        </div>

        <!-- Hotel Details -->
        <div class="hotel-details">
            <div class="hotel-header">
                <h1 th:text="${room.type}">Tên phòng</h1>
                <span th:if="${roomAvailable != null}" th:classappend=" ' room-status ' + (${roomAvailable} ? 'available' : 'booked') " th:text="${roomAvailable} ? 'Còn trống' : 'Đã được đặt'">Còn trống</span>
                <span th:if="${roomAvailable == null}" class="room-status unknown">Không xác định</span>
                <div class="info">
                    <div class="rating" th:text="${#numbers.formatDecimal(room.averageRating, 1, 1)}">8.9</div>
                    <div class="location"><i class="fas fa-map-marker-alt"></i> <span th:text="${room.description}">Bãi biển Non Nước, Đà Nẵng</span></div>
                </div>
                
                <!-- Room Actions -->
                <div class="room-actions">
                    <button class="action-btn favorite" onclick="toggleFavorite()" title="Yêu thích">
                        <i class="far fa-heart"></i>
                    </button>
                    <button class="action-btn share" onclick="shareRoom()" title="Chia sẻ">
                        <i class="fas fa-share-alt"></i>
                    </button>
                    <button class="action-btn print" onclick="window.print()" title="In">
                        <i class="fas fa-print"></i>
                    </button>
                </div>
            </div>

            <!-- Room Details Grid -->
            <div class="room-details-grid animate-slide">
                <div class="detail-item">
                    <i class="fas fa-users"></i>
                    <span>Sức chứa: <strong th:text="${room.capacity}">2</strong> người</span>
                </div>
                <div class="detail-item">
                    <i class="fas fa-bed"></i>
                    <span>Loại giường: <strong th:text="${room.bedType != null ? room.bedType : 'Chưa cập nhật'}">King Bed</strong></span>
                </div>
                <div class="detail-item">
                    <i class="fas fa-eye"></i>
                    <span>View: <strong th:text="${room.view != null ? room.view : 'Chưa cập nhật'}">Sea View</strong></span>
                </div>
                <div class="detail-item">
                    <i class="fas fa-building"></i>
                    <span>Tầng: <strong th:text="${room.floor}">5</strong></span>
                </div>
                <div class="detail-item">
                    <i class="fas fa-bath"></i>
                    <span>Phòng tắm: <strong th:text="${room.bathroomType != null ? room.bathroomType : 'Chưa cập nhật'}">Shower</strong></span>
                </div>
                <div class="detail-item">
                    <i class="fas fa-smoking-ban"></i>
                    <span>Hút thuốc: <strong th:text="${room.isSmoking ? 'Không cho phép' : 'Cho phép'}">Không cho phép</strong></span>
                </div>
            </div>

            <!-- Gallery -->
            <div class="hotel-gallery animate-fade">
                <img th:src="${room.imageUrls != null and !room.imageUrls.empty ? room.imageUrls[0] : 'https://images.unsplash.com/photo-1596436889106-be35e843f974?q=80&w=2070&auto=format&fit=crop'}" 
                     th:alt="${room.type}" class="main-img" onclick="openLightbox(this.src)">
                <img th:src="${room.imageUrls != null and room.imageUrls.size() > 1 ? room.imageUrls[1] : 'https://images.unsplash.com/photo-1600585154340-be6161a56a0c?q=80&w=2070&auto=format&fit=crop'}" 
                     th:alt="${room.type}" onclick="openLightbox(this.src)">
                <img th:src="${room.imageUrls != null and room.imageUrls.size() > 2 ? room.imageUrls[2] : 'https://images.unsplash.com/photo-1507525428034-b723cf961d3e?q=80&w=2070&auto=format&fit=crop'}" 
                     th:alt="${room.type}" onclick="openLightbox(this.src)">
                <img th:src="${room.imageUrls != null and room.imageUrls.size() > 3 ? room.imageUrls[3] : 'https://images.unsplash.com/photo-1507525428034-b723cf961d3e?q=80&w=2070&auto=format&fit=crop'}" 
                     th:alt="${room.type}" onclick="openLightbox(this.src)">
                <img th:src="${room.imageUrls != null and room.imageUrls.size() > 4 ? room.imageUrls[4] : 'https://images.unsplash.com/photo-1600585154340-be6161a56a0c?q=80&w=2070&auto=format&fit=crop'}" 
                     th:alt="${room.type}" onclick="openLightbox(this.src)">
            </div>

            <!-- Lightbox Modal -->
            <div id="lightboxModal" class="lightbox-modal">
                <span class="lightbox-close">&times;</span>
                <img class="lightbox-content" id="lightboxImg">
            </div>

            <!-- Hotel Info -->
            <div class="hotel-info">
                <div class="hotel-description animate-fade">
                    <h2>Giới thiệu</h2>
                    <p th:text="${room.description}">Mô tả phòng từ database</p>

                    <div class="hotel-amenities">
                        <h3>Tiện nghi</h3>
                        <div class="amenities-list">
                            <div class="amenity" th:each="amenity : ${room.amenities}">
                                <i class="fas fa-check"></i> 
                                <span th:text="${amenity}">Tiện nghi</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="hotel-booking animate-fade">
                    <h3>Đặt phòng ngay</h3>
                    <div class="price" th:text="'Từ ' + ${#numbers.formatDecimal(room.price, 0, 'COMMA', 0, 'POINT')} + ' ₫/đêm'">Từ 2,500,000 ₫/đêm</div>
                    
                    <div class="room-available-info">
                        <span th:if="${roomAvailableCount != null}">
                            <i class="fas fa-door-open"></i> Còn <strong th:text="${roomAvailableCount}">0</strong> phòng trống
                        </span>
                        <span th:if="${roomAvailableCount == 0}">
                    <div class="room-available-info">
                        <span th:if="${roomAvailableCount != null}" style="font-size:15px; color:#22c55e;">
                            <i class="fas fa-door-open"></i> Còn <b th:text="${roomAvailableCount}">0</b> phòng trống
                        </span>
                        <span th:if="${roomAvailableCount == 0}" style="font-size:15px; color:#e74c3c;">
                            <i class="fas fa-door-closed"></i> Hết phòng
                        </span>
                    </div>
                    
                    <form th:if="${currentUser != null}" th:action="@{/process-booking}" method="post" id="bookingForm">
                        <input type="hidden" name="roomId" th:value="${room.roomId}">
                        <input type="hidden" name="roomQuantity" value="1">
                        
                        <div class="input-group">
                            <i class="fas fa-user"></i>
                            <input type="text" name="customerName" placeholder="Họ và tên" 
                                   th:value="${currentUser != null ? currentUser.name : ''}" required>
                        </div>
                        <div class="input-group">
                            <i class="fas fa-envelope"></i>

                            <input type="email" name="email" placeholder="Email" 
                                   th:value="${currentUser != null ? currentUser.email : ''}" required>
                        </div>
                        <div class="input-group">
                            <i class="fas fa-phone"></i>
                            <input type="tel" name="phone" placeholder="Số điện thoại" 
                                   th:value="${currentUser != null ? currentUser.phone : ''}" required>
                        </div>
                        <div class="input-group">
                            <i class="fas fa-calendar-alt"></i>
                            <input type="date" name="checkInDate" th:value="${param.checkInDate != null ? param.checkInDate : ''}" required>
                        </div>
                        <div class="input-group">
                            <i class="fas fa-calendar-alt"></i>
                            <input type="date" name="checkOutDate" id="checkOutDate" required>
                        </div>
                        <div class="input-group">
                            <i class="fas fa-comment"></i>

                            <textarea name="specialRequests" placeholder="Yêu cầu đặc biệt (không bắt buộc)" rows="3"></textarea>
                        </div>
                        
                        <button type="submit" th:disabled="${roomAvailableCount == 0}">Tiếp tục đặt phòng</button>

                    </form>
                    
                    <!-- Login Button for Non-Authenticated Users -->
                    <div th:if="${currentUser == null}" style="text-align: center; margin-top: 1rem;">
                        <a href="/login" class="btn btn-primary">
                            <i class="fas fa-sign-in-alt"></i> Đăng nhập để đặt phòng
                        </a>
                    </div>
                </div>
            </div>

            <!-- Tách phần review ra ngoài hotel-info -->
            <div class="hotel-reviews">
                <div class="reviews-header">
                    <h2>Đánh giá từ khách hàng</h2>
                    <div class="reviews-filter">
                        <select id="ratingFilter">
                            <option value="">Tất cả đánh giá</option>
                            <option value="5">5 sao</option>
                            <option value="4">4 sao</option>
                            <option value="3">3 sao</option>
                            <option value="2">2 sao</option>
                            <option value="1">1 sao</option>
                        </select>
                    </div>
                </div>
                <div class="reviews-stats">
                    <div class="average-rating">
                        <span class="rating-number" th:text="${#numbers.formatDecimal(room.averageRating, 1, 1)}">4.5</span>
                        <div class="stars">
                            <i class="fas fa-star" th:each="i : ${#numbers.sequence(1, 5)}" 
                               th:class="${i <= room.averageRating ? 'filled' : ''}"></i>
                        </div>
                        <span class="total-reviews" th:text="${reviews.size()} + ' đánh giá'">15 đánh giá</span>
                    </div>
                </div>
                <!-- Write Review Section -->
                <div class="write-review-section" th:if="${currentUser != null}">
                    <div class="write-review-header">
                        <div>
                            <h3>Chia sẻ trải nghiệm của bạn</h3>
                            <p>Hãy để lại đánh giá để giúp những khách hàng khác có thể đưa ra quyết định tốt nhất</p>
                        </div>
                        <button class="write-review-toggle" onclick="toggleReviewForm()">
                            <i class="fas fa-edit"></i> Viết đánh giá
                        </button>
                    </div>
                    <form class="review-form" id="reviewForm" th:action="@{/submit-review}" method="post" enctype="multipart/form-data">
                        <input type="hidden" name="roomId" th:value="${room.roomId}">
                        <div class="star-rating">
                            <label>Đánh giá của bạn:</label>
                            <div class="stars" id="starRating">
                                <i class="far fa-star" data-rating="1"></i>
                                <i class="far fa-star" data-rating="2"></i>
                                <i class="far fa-star" data-rating="3"></i>
                                <i class="far fa-star" data-rating="4"></i>
                                <i class="far fa-star" data-rating="5"></i>
                            </div>
                            <span class="rating-text" id="ratingText"></span>
                            <input type="hidden" name="rating" id="ratingValue" required>
                        </div>
                        <div class="form-group">
                            <label for="reviewTitle">Tiêu đề đánh giá</label>
                            <input type="text" id="reviewTitle" name="title" placeholder="Tóm tắt trải nghiệm của bạn..." required>
                        </div>
                        <div class="form-group">
                            <label for="reviewComment">Nội dung đánh giá</label>
                            <textarea id="reviewComment" name="comment" placeholder="Chia sẻ chi tiết về trải nghiệm của bạn tại đây..." required></textarea>
                        </div>
                        <div class="image-upload">
                            <label>Thêm hình ảnh (tùy chọn)</label>
                            <div class="image-upload-btn">
                                <i class="fas fa-camera"></i>
                                <span>Chọn hình ảnh để chia sẻ</span>
                                <input type="file" name="images" multiple accept="image/*" onchange="previewImages(this)">
                            </div>
                            <div class="image-preview" id="imagePreview"></div>
                        </div>
                        <button type="submit" class="submit-review-btn" disabled>
                            <i class="fas fa-paper-plane"></i> 
                            <span>Gửi đánh giá</span>
                        </button>
                    </form>
                    
                    <!-- Login Button for Non-Authenticated Users -->
                    <div th:if="${currentUser == null}" style="text-align: center; margin-top: 20px;">
                        <a href="/login" class="btn btn-primary" style="background: #007bff; color: white; padding: 12px 24px; border-radius: 4px; text-decoration: none; display: inline-block;">
                            <i class="fas fa-sign-in-alt"></i> Đăng nhập để đặt phòng
                        </a>
                    </div>
                </div>
                <div class="review" th:each="review : ${reviews}">
                    <div class="review-header">
                        <span class="reviewer" th:text="${review.customer.name}">Tên khách hàng</span>
                        <div class="rating" th:text="${review.rating} + '/5'">9.2</div>
                    </div>
                    <p th:text="${review.comment}">Nội dung đánh giá</p>
                    <div class="response" th:if="${review.response != null}">
                        <strong>Phản hồi từ khách sạn:</strong>
                        <p th:text="${review.response}"></p>
                    </div>
                </div>
            </div>
        </div>
        </div>

        <!-- Related Hotels Carousel -->
        <div class="related-hotels">
            <h2>Các phòng liên quan</h2>
            <div class="carousel-container">
                <button class="carousel-nav prev" id="prevBtn">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="hotel-list" id="hotelCarousel">
                    <div class="hotel-card" th:each="relatedRoom : ${relatedRooms}">
                        <img th:src="${relatedRoom.imageUrls != null and !relatedRoom.imageUrls.empty ? relatedRoom.imageUrls[0] : 'https://images.unsplash.com/photo-1600585154340-be6161a56a0c?q=80&w=2070&auto=format&fit=crop'}" 
                             th:alt="${relatedRoom.type}">
                        <div class="content">
                            <h3 th:text="${relatedRoom.type}">Tên phòng</h3>
                            <p th:text="${relatedRoom.description}">Mô tả phòng</p>
                            <div class="rating" th:text="${#numbers.formatDecimal(relatedRoom.averageRating, 1, 1)}">8.5</div>
                            <p class="price" th:text="${#numbers.formatDecimal(relatedRoom.price, 0, 'COMMA', 0, 'POINT')} + ' ₫/đêm'">1,800,000 ₫/đêm</p>
                            <a th:href="@{/room/{id}(id=${relatedRoom.roomId})}" class="view-detail-btn">Xem chi tiết</a>
                        </div>
                    </div>
                </div>
                <button class="carousel-nav next" id="nextBtn">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
            <div class="carousel-indicators" id="carouselIndicators"></div>
        </div>

        <!-- Footer -->
        <div th:replace="~{/Layout/footer}"></div>
    </div>

    <!-- JavaScript -->
    <script>
        // Lightbox functionality
        function openLightbox(src) {
            const modal = document.getElementById('lightboxModal');
            const modalImg = document.getElementById('lightboxImg');
            modal.style.display = 'block';
            modalImg.src = src;
        }

        // Close lightbox
        document.querySelector('.lightbox-close').addEventListener('click', function() {
            document.getElementById('lightboxModal').style.display = 'none';
        });

        document.getElementById('lightboxModal').addEventListener('click', function(e) {
            if (e.target === this) {
                this.style.display = 'none';
            }
        });

        // Toggle Review Form
        function toggleReviewForm() {
            const form = document.getElementById('reviewForm');
            const button = document.querySelector('.write-review-toggle');
            
            if (form.classList.contains('active')) {
                form.classList.remove('active');
                button.innerHTML = '<i class="fas fa-edit"></i> Viết đánh giá';
            } else {
                form.classList.add('active');
                button.innerHTML = '<i class="fas fa-times"></i> Đóng';
            }
        }

        // Star Rating System
        function initStarRating() {
            const stars = document.querySelectorAll('#starRating i');
            const ratingValue = document.getElementById('ratingValue');
            const ratingText = document.getElementById('ratingText');
            
            const ratingTexts = {
                1: 'Rất tệ',
                2: 'Tệ',
                3: 'Bình thường',
                4: 'Tốt',
                5: 'Xuất sắc'
            };

            stars.forEach((star, index) => {
                star.addEventListener('click', () => {
                    const rating = index + 1;
                    ratingValue.value = rating;
                    
                    // Update star display
                    stars.forEach((s, i) => {
                        if (i < rating) {
                            s.classList.remove('far');
                            s.classList.add('fas', 'active');
                        } else {
                            s.classList.remove('fas', 'active');
                            s.classList.add('far');
                        }
                    });
                    
                    // Update rating text
                    ratingText.textContent = ratingTexts[rating];
                    ratingText.classList.add('show');
                    
                    // Enable submit button
                    checkFormValidity();
                });

                star.addEventListener('mouseenter', () => {
                    const rating = index + 1;
                    stars.forEach((s, i) => {
                        if (i < rating) {
                            s.style.color = '#FFA500';
                            s.style.transform = 'scale(1.1)';
                        } else {
                            s.style.color = '#d1d5db';
                            s.style.transform = 'scale(1)';
                        }
                    });
                });

                star.addEventListener('mouseleave', () => {
                    stars.forEach((s, i) => {
                        if (s.classList.contains('active')) {
                            s.style.color = '#FFA500';
                            s.style.transform = 'scale(1.1)';
                        } else {
                            s.style.color = '#d1d5db';
                            s.style.transform = 'scale(1)';
                        }
                    });
                });
            });
        }

        // Image Preview
        function previewImages(input) {
            const preview = document.getElementById('imagePreview');
            preview.innerHTML = '';
            
            if (input.files) {
                Array.from(input.files).forEach((file, index) => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const div = document.createElement('div');
                        div.className = 'image-preview-item';
                        div.innerHTML = `
                            <img src="${e.target.result}" alt="Preview ${index + 1}">
                            <button type="button" class="image-remove" onclick="removeImage(${index})">×</button>
                        `;
                        preview.appendChild(div);
                    };
                    reader.readAsDataURL(file);
                });
            }
        }

        // Remove Image
        function removeImage(index) {
            const input = document.querySelector('input[type="file"]');
            const dt = new DataTransfer();
            
            Array.from(input.files).forEach((file, i) => {
                if (i !== index) {
                    dt.items.add(file);
        // Calculate booking price and nights
        function calculateBooking() {
            const checkInInput = document.querySelector('input[name="checkInDate"]');
            const checkOutInput = document.querySelector('input[name="checkOutDate"]');
            const basePriceElement = document.querySelector('.price');
            
            if (!checkInInput || !checkOutInput || !basePriceElement) {
                return;
            }
            
            const checkIn = new Date(checkInInput.value);
            const checkOut = new Date(checkOutInput.value);
            const basePrice = parseFloat(basePriceElement.textContent.replace(/[^\d]/g, ''));
            const voucherSelect = document.getElementById('voucherSelect');
            
            if (checkIn && checkOut && checkOut > checkIn) {
                const nights = Math.ceil((checkOut - checkIn) / (1000 * 60 * 60 * 24));
                const totalBase = basePrice * nights;
                
                const nightsCountElement = document.getElementById('nightsCount');
                const basePriceElement2 = document.getElementById('basePrice');
                const discountRowElement = document.getElementById('discountRow');
                const discountAmountElement = document.getElementById('discountAmount');
                const totalPriceElement = document.getElementById('totalPrice');
                
                if (nightsCountElement) nightsCountElement.textContent = nights;
                if (basePriceElement2) basePriceElement2.textContent = totalBase.toLocaleString() + ' ₫';
                
                // Calculate discount if voucher selected
                if (voucherSelect && voucherSelect.value) {
                    const selectedOption = voucherSelect.options[voucherSelect.selectedIndex];
                    const discountPercent = parseFloat(selectedOption.dataset.discount);
                    const discountAmount = totalBase * (discountPercent / 100);
                    const finalPrice = totalBase - discountAmount;
                    
                    if (discountRowElement) discountRowElement.style.display = 'block';
                    if (discountAmountElement) discountAmountElement.textContent = `-${discountAmount.toLocaleString()} ₫`;
                    if (totalPriceElement) totalPriceElement.textContent = `${finalPrice.toLocaleString()} ₫`;
                } else {
                    if (discountRowElement) discountRowElement.style.display = 'none';
                    if (totalPriceElement) totalPriceElement.textContent = `${totalBase.toLocaleString()} ₫`;
                }
            }
        }

        // Filter reviews
        function filterReviews() {
            const filterValue = document.getElementById('ratingFilter')?.value;
            const reviews = document.querySelectorAll('.review');
            
            reviews.forEach(review => {
                const ratingElement = review.querySelector('.rating');
                if (ratingElement) {
                    const rating = ratingElement.textContent.split('/')[0];
                    if (!filterValue || rating == filterValue) {
                        review.style.display = 'block';
                    } else {
                        review.style.display = 'none';
                    }
                }
            });
            
            input.files = dt.files;
            previewImages(input);
        }

        // Check Form Validity
        function checkFormValidity() {
            const rating = document.getElementById('ratingValue').value;
            const title = document.getElementById('reviewTitle').value;
            const comment = document.getElementById('reviewComment').value;
            const submitBtn = document.querySelector('.submit-review-btn');
            
            if (rating && title.trim() && comment.trim()) {
                submitBtn.disabled = false;
            } else {
                submitBtn.disabled = true;
        // Form validation
        function validateForm() {
            console.log('Validating form...');
            let isValid = true;
            
            // Validate name
            const name = document.querySelector('input[name="customerName"]');
            if (name && name.value.trim() === '') {
                showNotification('Vui lòng nhập họ và tên', 'error');
                isValid = false;
            } else if (name && !name.value.match(/^[A-Za-zÀ-ỹ\s]+$/)) {
                showNotification('Tên chỉ được chứa chữ cái và dấu cách', 'error');
                isValid = false;
            }
        }

        // Carousel functionality
        function initCarousel() {
            const carousel = document.getElementById('hotelCarousel');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const indicators = document.getElementById('carouselIndicators');
            const cards = carousel.querySelectorAll('.hotel-card');
            
            if (cards.length === 0) return;
            
            let currentIndex = 0;
            const cardWidth = 320 + 32; // card width + gap
            const visibleCards = Math.floor(carousel.parentElement.offsetWidth / cardWidth);
            const maxIndex = Math.max(0, cards.length - visibleCards);
            
            // Create indicators
            for (let i = 0; i <= maxIndex; i++) {
                const indicator = document.createElement('div');
                indicator.className = 'carousel-indicator';
                if (i === 0) indicator.classList.add('active');
                indicator.addEventListener('click', () => goToSlide(i));
                indicators.appendChild(indicator);
            }
            
            function updateCarousel() {
                const translateX = -currentIndex * cardWidth;
                carousel.style.transform = `translateX(${translateX}px)`;
                
                // Update indicators
                indicators.querySelectorAll('.carousel-indicator').forEach((indicator, i) => {
                    indicator.classList.toggle('active', i === currentIndex);
                });
                
                // Update button states
                prevBtn.disabled = currentIndex === 0;
                nextBtn.disabled = currentIndex === maxIndex;
            }
            
            function goToSlide(index) {
                currentIndex = Math.max(0, Math.min(index, maxIndex));
                updateCarousel();
            }
            
            prevBtn.addEventListener('click', () => {
                if (currentIndex > 0) {
                    currentIndex--;
                    updateCarousel();
                }
            });
            
            nextBtn.addEventListener('click', () => {
                if (currentIndex < maxIndex) {
                    currentIndex++;
                    updateCarousel();
                }
            });
            
            // Touch/swipe support for mobile
            let startX = 0;
            let isDragging = false;
            
            carousel.addEventListener('touchstart', (e) => {
                startX = e.touches[0].clientX;
                isDragging = true;
            });
            
            carousel.addEventListener('touchmove', (e) => {
                if (!isDragging) return;
                e.preventDefault();
            });
            
            carousel.addEventListener('touchend', (e) => {
                if (!isDragging) return;
                isDragging = false;
                
                const endX = e.changedTouches[0].clientX;
                const diff = startX - endX;
                
                if (Math.abs(diff) > 50) {
                    if (diff > 0 && currentIndex < maxIndex) {
                        currentIndex++;
                    } else if (diff < 0 && currentIndex > 0) {
                        currentIndex--;
                    }
                    updateCarousel();
                }
            });
            
            // Initialize
            updateCarousel();
            
            // Handle window resize
            window.addEventListener('resize', () => {
                const newVisibleCards = Math.floor(carousel.parentElement.offsetWidth / cardWidth);
                const newMaxIndex = Math.max(0, cards.length - newVisibleCards);
                
                if (currentIndex > newMaxIndex) {
                    currentIndex = newMaxIndex;
                }
                
                // Recreate indicators
                indicators.innerHTML = '';
                for (let i = 0; i <= newMaxIndex; i++) {
                    const indicator = document.createElement('div');
                    indicator.className = 'carousel-indicator';
                    if (i === currentIndex) indicator.classList.add('active');
                    indicator.addEventListener('click', () => goToSlide(i));
                    indicators.appendChild(indicator);
                }
                
                updateCarousel();
            });
            // Validate phone
            const phone = document.querySelector('input[name="phone"]');
            if (phone && phone.value.trim() === '') {
                showNotification('Vui lòng nhập số điện thoại', 'error');
                isValid = false;
            } else if (phone && !phone.value.match(/^[0-9]{10,11}$/)) {
                showNotification('Số điện thoại phải có 10-11 chữ số', 'error');
                isValid = false;
            }
            
            // Validate email
            const email = document.querySelector('input[name="email"]');
            if (email && email.value.trim() === '') {
                showNotification('Vui lòng nhập email', 'error');
                isValid = false;
            } else if (email && !email.value.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
                showNotification('Email không hợp lệ', 'error');
                isValid = false;
            }
            
            // Validate dates
            const checkIn = document.querySelector('input[name="checkInDate"]');
            const checkOut = document.querySelector('input[name="checkOutDate"]');
            
            console.log('Check-in value:', checkIn ? checkIn.value : 'null');
            console.log('Check-out value:', checkOut ? checkOut.value : 'null');
            
            if (checkIn && checkOut) {
                const checkInDate = new Date(checkIn.value);
                const checkOutDate = new Date(checkOut.value);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                console.log('Check-in date:', checkInDate);
                console.log('Check-out date:', checkOutDate);
                console.log('Today:', today);
                
                if (checkInDate < today) {
                    console.log('Check-in date is in the past');
                    showNotification('Ngày nhận phòng không thể là ngày trong quá khứ', 'error');
                    isValid = false;
                }
                
                if (checkOutDate <= checkInDate) {
                    console.log('Check-out date is not after check-in date');
                    showNotification('Ngày trả phòng phải sau ngày nhận phòng', 'error');
                    isValid = false;
                }
            }
            
            console.log('Form validation result:', isValid);
            return isValid;
        }

        // Toggle favorite
        function toggleFavorite() {
            const btn = document.querySelector('.favorite');
            if (btn) {
                const icon = btn.querySelector('i');
                if (icon) {
                    if (icon.classList.contains('far')) {
                        icon.classList.remove('far');
                        icon.classList.add('fas');
                        btn.style.color = '#ef4444';
                        btn.style.color = '#e74c3c';
                        showNotification('Đã thêm vào danh sách yêu thích!', 'success');
                    } else {
                        icon.classList.remove('fas');
                        icon.classList.add('far');
                        btn.style.color = '';
                        showNotification('Đã xóa khỏi danh sách yêu thích!', 'info');
                    }
                }
            }
        }

        // Share room
        function shareRoom() {
            if (navigator.share) {
                const titleElement = document.querySelector('.hotel-header h1');
                const title = titleElement ? titleElement.textContent : document.title;
                navigator.share({
                    title: document.title,
                    text: title,
                    url: window.location.href
                });
            } else {
                const url = window.location.href;
                navigator.clipboard.writeText(url).then(() => {
                    showNotification('Đã sao chép link vào clipboard!', 'success');
                }).catch(() => {
                    showNotification('Không thể sao chép link', 'error');
                });
            }
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            let bgGradient;
            switch(type) {
                case 'success':
                    bgGradient = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
                    break;
                case 'error':
                    bgGradient = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
                    break;
                default:
                    bgGradient = 'linear-gradient(135deg, #8B7CF6 0%, #7C3AED 100%)';
            }
            
            notification.style.cssText = `
                position: fixed;
                top: 2rem;
                right: 2rem;
                padding: 1rem 1.5rem;
                border-radius: 0.75rem;
                color: white;
                font-weight: 600;
                z-index: 10000;
                animation: slideInRight 0.3s ease;
                box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
                background: ${bgGradient};
                border: 1px solid rgba(255,255,255,0.2);
                backdrop-filter: blur(10px);
                animation: slideInRight 0.3s ease-out;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                ${type === 'success' ? 'background: #27ae60;' : 
                  type === 'error' ? 'background: #e74c3c;' : 'background: #3498db;'}
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // Form validation
        function validateForm() {
            let isValid = true;
            
            const name = document.querySelector('input[name="customerName"]');
            if (name && name.value.trim() === '') {
                showNotification('Vui lòng nhập họ và tên', 'error');
                isValid = false;
            }
            
            const phone = document.querySelector('input[name="phone"]');
            if (phone && phone.value.trim() === '') {
                showNotification('Vui lòng nhập số điện thoại', 'error');
                isValid = false;
            } else if (phone && !phone.value.match(/^[0-9]{10,11}$/)) {
                showNotification('Số điện thoại phải có 10-11 chữ số', 'error');
                isValid = false;
            }
            
            const email = document.querySelector('input[name="email"]');
            if (email && email.value.trim() === '') {
                showNotification('Vui lòng nhập email', 'error');
                isValid = false;
            } else if (email && !email.value.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
                showNotification('Email không hợp lệ', 'error');
                isValid = false;
            }
            
            const checkIn = document.querySelector('input[name="checkInDate"]');
            const checkOut = document.querySelector('input[name="checkOutDate"]');
            
            if (checkIn && checkOut) {
                const checkInDate = new Date(checkIn.value);
                const checkOutDate = new Date(checkOut.value);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                if (checkInDate < today) {
                    showNotification('Ngày nhận phòng không thể là ngày trong quá khứ', 'error');
                    isValid = false;
                }
                
                if (checkOutDate <= checkInDate) {
                    showNotification('Ngày trả phòng phải sau ngày nhận phòng', 'error');
                    isValid = false;
                }
            }
            
            return isValid;
        }

        // Filter reviews
        function filterReviews() {
            const filterValue = document.getElementById('ratingFilter')?.value;
            const reviews = document.querySelectorAll('.review');
            
            reviews.forEach(review => {
                const ratingElement = review.querySelector('.rating');
                if (ratingElement) {
                    const rating = ratingElement.textContent.split('/')[0];
                    if (!filterValue || rating == filterValue) {
                        review.style.display = 'block';
                    } else {
                        review.style.display = 'none';
                    }
                }
            });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize star rating
            initStarRating();
            
            // Initialize carousel
            initCarousel();
            
            // Add event listeners for form validation
            const reviewTitle = document.getElementById('reviewTitle');
            const reviewComment = document.getElementById('reviewComment');
            
            if (reviewTitle) {
                reviewTitle.addEventListener('input', checkFormValidity);
            // Set minimum date for check-out based on check-in
            const checkInInput = document.querySelector('input[name="checkInDate"]');
            const checkOutInput = document.querySelector('input[name="checkOutDate"]');
            
            if (checkInInput && checkOutInput) {
                            // Set minimum date for check-in (today)
            const today = new Date().toISOString().split('T')[0];
            checkInInput.min = today;
            
            // Set default check-in date to today if not already set
            if (!checkInInput.value) {
                checkInInput.value = today;
            }
            
            // Set default check-out date to tomorrow if not already set
            if (!checkOutInput.value) {
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                checkOutInput.value = tomorrow.toISOString().split('T')[0];
            }
            
            // Set minimum date for check-out based on check-in
            checkInInput.addEventListener('change', function() {
                const checkInDate = new Date(this.value);
                const nextDay = new Date(checkInDate);
                nextDay.setDate(nextDay.getDate() + 1);
                
                checkOutInput.min = nextDay.toISOString().split('T')[0];
                
                // If current check-out date is before new minimum, update it
                if (checkOutInput.value && new Date(checkOutInput.value) <= checkInDate) {
                    checkOutInput.value = nextDay.toISOString().split('T')[0];
                }
            });
            
            // Force set check-out date to tomorrow if it's not set or same as check-in
            if (!checkOutInput.value || checkOutInput.value === checkInInput.value) {
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                checkOutInput.value = tomorrow.toISOString().split('T')[0];
            }
            
            checkInInput.addEventListener('change', function() {
                const checkInDate = new Date(this.value);
                const nextDay = new Date(checkInDate);
                nextDay.setDate(nextDay.getDate() + 1);
                
                checkOutInput.min = nextDay.toISOString().split('T')[0];
                
                // If current check-out date is before new minimum, update it
                if (checkOutInput.value && new Date(checkOutInput.value) <= checkInDate) {
                    checkOutInput.value = nextDay.toISOString().split('T')[0];
                }
            });
            }
            
            const voucherSelect = document.getElementById('voucherSelect');
            if (voucherSelect) {
                voucherSelect.addEventListener('change', calculateBooking);
            }
            
            const ratingFilter = document.getElementById('ratingFilter');
            if (ratingFilter) {
                ratingFilter.addEventListener('change', filterReviews);
            }
            
            // Form validation
            const bookingForm = document.getElementById('bookingForm');
            if (bookingForm) {
                bookingForm.addEventListener('submit', function(e) {
                    console.log('Form submit triggered');
                    
                    // Force validate dates before submit
                    const checkIn = document.querySelector('input[name="checkInDate"]');
                    const checkOut = document.querySelector('input[name="checkOutDate"]');
                    
                    if (checkIn && checkOut) {
                        const checkInDate = new Date(checkIn.value);
                        const checkOutDate = new Date(checkOut.value);
                        
                        // If dates are the same, set check-out to next day
                        if (checkInDate.getTime() === checkOutDate.getTime()) {
                            const nextDay = new Date(checkInDate);
                            nextDay.setDate(nextDay.getDate() + 1);
                            checkOut.value = nextDay.toISOString().split('T')[0];
                            console.log('Auto-corrected check-out date to:', checkOut.value);
                        }
                    }
                    
                    if (!validateForm()) {
                        console.log('Form validation failed');
                        e.preventDefault();
                        showNotification('Vui lòng kiểm tra lại thông tin!', 'error');
                        return false;
                    }
                    console.log('Form validation passed, submitting...');
                    return true;
                });
            }
            
            if (reviewComment) {
                reviewComment.addEventListener('input', checkFormValidity);
            }
            
            // Set minimum date for check-out based on check-in
            const checkInInput = document.querySelector('input[name="checkInDate"]');
            const checkOutInput = document.querySelector('input[name="checkOutDate"]');
            
            if (checkInInput && checkOutInput) {
                const today = new Date().toISOString().split('T')[0];
                checkInInput.min = today;
                
                if (!checkInInput.value) {
                    checkInInput.value = today;
                }
                
                if (!checkOutInput.value) {
                    const tomorrow = new Date();
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    checkOutInput.value = tomorrow.toISOString().split('T')[0];
                }
                
                checkInInput.addEventListener('change', function() {
                    const checkInDate = new Date(this.value);
                    const nextDay = new Date(checkInDate);
                    nextDay.setDate(nextDay.getDate() + 1);
                    
                    checkOutInput.min = nextDay.toISOString().split('T')[0];
                    
                    if (checkOutInput.value && new Date(checkOutInput.value) <= checkInDate) {
                        checkOutInput.value = nextDay.toISOString().split('T')[0];
                    }
                });
            }
            
            const ratingFilter = document.getElementById('ratingFilter');
            if (ratingFilter) {
                ratingFilter.addEventListener('change', filterReviews);
            }
            
            // Form validation for booking
            const bookingForm = document.getElementById('bookingForm');
            if (bookingForm) {
                bookingForm.addEventListener('submit', function(e) {
                    if (!validateForm()) {
                        e.preventDefault();
                        return false;
                    }
                    return true;
                });
            }
            
            // Form validation for review
            const reviewForm = document.getElementById('reviewForm');
            if (reviewForm) {
                reviewForm.addEventListener('submit', function(e) {
                    const rating = document.getElementById('ratingValue').value;
                    const title = document.getElementById('reviewTitle').value;
                    const comment = document.getElementById('reviewComment').value;
                    
                    if (!rating || !title.trim() || !comment.trim()) {
                        e.preventDefault();
                        showNotification('Vui lòng điền đầy đủ thông tin đánh giá!', 'error');
                        return false;
                    }
                    
                    showNotification('Đang gửi đánh giá...', 'info');
                    return true;
                });
            }
        });

        // Add CSS animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from {
                    opacity: 0;
                    transform: translateX(100%);
                }
                to {
                    opacity: 1;
                    transform: translateX(0);
                }
            }
            
            @keyframes slideOutRight {
                from {
                    opacity: 1;
                    transform: translateX(0);
                }
                to {
                    opacity: 0;
                    transform: translateX(100%);
                }
            }
        `;
        document.head.appendChild(style);
            // Add CSS animations if not already added
            if (!document.getElementById('notification-animations')) {
                const style = document.createElement('style');
                style.id = 'notification-animations';
                style.textContent = `
                    @keyframes slideInRight {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes slideOutRight {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(100%); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }
        });

        // Show success/error messages on page load
        document.addEventListener('DOMContentLoaded', function() {
            /*[# th:if="${message}"]*/
            showNotification(/*[[${message}]]*/ 'Message', 'success');
            /*[/]*/
            
            /*[# th:if="${error}"]*/
            showNotification(/*[[${error}]]*/ 'Error', 'error');
            /*[/]*/
        });
    </script>
</body>
</html>